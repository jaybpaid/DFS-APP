<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DFS Bloomberg Terminal</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap');

      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Roboto', Arial, sans-serif;
        background: #1a1a1a;
        color: #ffffff;
        font-size: 12px;
        line-height: 1.4;
        overflow-x: auto;
      }

      .bloomberg-container {
        display: grid;
        grid-template-rows: auto 1fr;
        height: 100vh;
        background: linear-gradient(180deg, #2c2c2c 0%, #1a1a1a 100%);
      }

      .top-bar {
        background: #000;
        border-bottom: 2px solid #ff6600;
        padding: 8px 15px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 11px;
      }

      .logo {
        color: #ff6600;
        font-weight: 700;
        font-size: 14px;
      }

      .ticker {
        display: flex;
        gap: 20px;
        color: #00ff00;
      }

      .ticker-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .status-indicator {
        width: 8px;
        height: 8px;
        background: #00ff00;
        border-radius: 50%;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.3;
        }
      }

      .main-grid {
        display: grid;
        grid-template-columns: 250px 1fr 300px;
        height: calc(100vh - 50px);
      }

      .left-panel {
        background: #2a2a2a;
        border-right: 1px solid #444;
        overflow-y: auto;
      }

      .center-panel {
        background: #1e1e1e;
        display: flex;
        flex-direction: column;
      }

      .right-panel {
        background: #252525;
        border-left: 1px solid #444;
        display: flex;
        flex-direction: column;
        overflow-y: auto;
      }

      .panel-header {
        background: #333;
        color: #ff6600;
        padding: 8px 12px;
        font-weight: 600;
        border-bottom: 1px solid #444;
        font-size: 11px;
        text-transform: uppercase;
      }

      .contest-list {
        padding: 10px;
      }

      .contest-item {
        background: #333;
        border: 1px solid #555;
        margin-bottom: 8px;
        padding: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 11px;
      }

      .contest-item:hover {
        background: #404040;
        border-color: #ff6600;
      }

      .contest-item.selected {
        background: #ff6600;
        color: #000;
        border-color: #ff6600;
      }

      .contest-name {
        font-weight: 600;
        margin-bottom: 3px;
      }

      .contest-details {
        opacity: 0.8;
        font-size: 10px;
      }

      .player-grid {
        flex: 1;
        padding: 10px;
        overflow-y: auto;
      }

      .player-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 11px;
      }

      .player-table th {
        background: #333;
        color: #ff6600;
        padding: 6px;
        text-align: left;
        font-weight: 600;
        border-bottom: 1px solid #555;
        position: sticky;
        top: 0;
      }

      .player-table td {
        padding: 4px 6px;
        border-bottom: 1px solid #333;
      }

      .player-table tr:hover {
        background: #2a2a2a;
      }

      .value-good {
        color: #00ff00;
      }
      .value-ok {
        color: #ffff00;
      }
      .value-poor {
        color: #ff6666;
      }

      .control-panel {
        padding: 15px;
      }

      .control-group {
        margin-bottom: 15px;
      }

      .control-label {
        display: block;
        color: #ff6600;
        font-size: 11px;
        font-weight: 500;
        margin-bottom: 5px;
      }

      .control-input {
        width: 100%;
        padding: 6px;
        background: #333;
        border: 1px solid #555;
        color: white;
        font-size: 11px;
      }

      .control-input:focus {
        outline: none;
        border-color: #ff6600;
      }

      .optimize-btn {
        width: 100%;
        background: linear-gradient(135deg, #ff6600, #cc5200);
        border: none;
        color: white;
        padding: 12px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        font-size: 11px;
      }

      .optimize-btn:hover {
        background: linear-gradient(135deg, #cc5200, #ff6600);
        box-shadow: 0 4px 15px rgba(255, 102, 0, 0.3);
      }

      .optimize-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .lineup-results {
        padding: 10px;
        max-height: 400px;
        overflow-y: auto;
      }

      .lineup-card {
        background: #2a2a2a;
        border: 1px solid #444;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 4px;
      }

      .lineup-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        padding-bottom: 5px;
        border-bottom: 1px solid #333;
      }

      .lineup-id {
        color: #ff6600;
        font-weight: 600;
        font-size: 11px;
      }

      .lineup-score {
        color: #00ff00;
        font-weight: 600;
      }

      .lineup-players {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 3px;
        font-size: 10px;
      }

      .player-line {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
      }

      .market-data {
        padding: 10px;
        font-size: 10px;
      }

      .market-row {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        border-bottom: 1px dotted #333;
      }

      .market-label {
        color: #ccc;
      }

      .market-value {
        color: #00ff00;
        font-weight: 500;
      }

      @media (max-width: 1200px) {
        .main-grid {
          grid-template-columns: 200px 1fr 250px;
        }
      }

      @media (max-width: 768px) {
        .main-grid {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto;
        }

        .left-panel,
        .right-panel {
          max-height: 300px;
        }
      }
    </style>
  </head>
  <body>
    <div class="bloomberg-container">
      <div class="top-bar">
        <div class="logo">DFS TERMINAL</div>
        <div class="ticker">
          <div class="ticker-item">
            <div class="status-indicator"></div>
            <span id="api-connection">API ONLINE</span>
          </div>
          <div class="ticker-item">
            <span>PLAYERS: <span id="total-players">0</span></span>
          </div>
          <div class="ticker-item">
            <span>CONTESTS: <span id="total-contests">0</span></span>
          </div>
          <div class="ticker-item">
            <span>LINEUPS: <span id="total-lineups">0</span></span>
          </div>
          <div class="ticker-item">
            <span id="current-time">--:--:--</span>
          </div>
        </div>
      </div>

      <div class="main-grid">
        <!-- Left Panel: Contests -->
        <div class="left-panel">
          <div class="panel-header">Available Contests</div>
          <div class="contest-list" id="contest-list">
            <div style="text-align: center; padding: 20px; opacity: 0.6">
              Loading...
            </div>
          </div>
        </div>

        <!-- Center Panel: Player Pool -->
        <div class="center-panel">
          <div class="panel-header">
            Player Pool - <span id="selected-contest">Select Contest</span>
          </div>
          <div class="player-grid" id="player-grid">
            <div style="text-align: center; padding: 50px; opacity: 0.6">
              Select a contest to load player data
            </div>
          </div>
        </div>

        <!-- Right Panel: Controls & Results -->
        <div class="right-panel">
          <div class="panel-header">Optimization Controls</div>
          <div class="control-panel">
            <div class="control-group">
              <label class="control-label" for="num-lineups">Number of Lineups</label>
              <input
                type="number"
                id="num-lineups"
                value="20"
                min="1"
                max="150"
                class="control-input"
              />
            </div>

            <div class="control-group">
              <label class="control-label" for="uniqueness">Unique Players</label>
              <input
                type="number"
                id="uniqueness"
                value="6"
                min="1"
                max="9"
                class="control-input"
              />
            </div>

            <div class="control-group">
              <label class="control-label" for="min-salary">Min Salary</label>
              <input
                type="number"
                id="min-salary"
                value="49000"
                min="40000"
                max="50000"
                class="control-input"
              />
            </div>

            <button class="optimize-btn" id="optimize-btn" onclick="runOptimization()">
              Execute Optimization
            </button>
          </div>

          <div class="panel-header" style="margin-top: 20px">Market Analytics</div>
          <div class="market-data">
            <div class="market-row">
              <span class="market-label">Avg Salary:</span>
              <span class="market-value" id="avg-salary">$6,250</span>
            </div>
            <div class="market-row">
              <span class="market-label">Top Value:</span>
              <span class="market-value" id="top-value">3.2x</span>
            </div>
            <div class="market-row">
              <span class="market-label">Chalk Play:</span>
              <span class="market-value" id="chalk-play">Josh Allen</span>
            </div>
            <div class="market-row">
              <span class="market-label">Contrarian:</span>
              <span class="market-value" id="contrarian-play">T. Hill</span>
            </div>
          </div>

          <div class="panel-header" style="margin-top: 20px">Generated Lineups</div>
          <div class="lineup-results" id="lineup-results">
            <div
              style="text-align: center; padding: 20px; opacity: 0.6; font-size: 11px"
            >
              Run optimization to see results
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      const API_BASE = 'http://localhost:8001/api';
      const API_KEY = 'dfs-demo-key';
      let selectedSlateId = null;
      let currentPlayers = [];

      async function fetchWithAuth(url, options = {}) {
        return fetch(url, {
          ...options,
          headers: {
            'X-API-Key': API_KEY,
            'Content-Type': 'application/json',
            ...options.headers,
          },
        });
      }

      function updateTime() {
        const now = new Date();
        document.getElementById('current-time').textContent = now
          .toTimeString()
          .split(' ')[0];
      }

      async function loadContests() {
        try {
          const response = await fetchWithAuth(`${API_BASE}/slates`);
          const data = await response.json();

          const contestList = document.getElementById('contest-list');

          if (data.slates && data.slates.length > 0) {
            document.getElementById('total-contests').textContent = data.slates.length;
            contestList.innerHTML = data.slates
              .map(
                slate => `
                        <div class="contest-item" data-slate-id="${slate.id}" onclick="selectContest('${slate.id}', '${slate.name}', this)">
                            <div class="contest-name">${slate.name}</div>
                            <div class="contest-details">
                                ${slate.playerCount || 0} players • $${(slate.salaryCap || 50000).toLocaleString()}
                            </div>
                            <div class="contest-details" style="color: #00ff00;">
                                ${slate.status || 'ACTIVE'}
                            </div>
                        </div>
                    `
              )
              .join('');
          } else {
            // Fallback demo data
            document.getElementById('total-contests').textContent = '2';
            contestList.innerHTML = `
                        <div class="contest-item" data-slate-id="demo-1" onclick="selectContest('demo-1', 'NFL Week 3 - Main Slate', this)">
                            <div class="contest-name">NFL Week 3 - Main Slate</div>
                            <div class="contest-details">247 players • $50,000</div>
                            <div class="contest-details" style="color: #00ff00;">ACTIVE</div>
                        </div>
                        <div class="contest-item" data-slate-id="demo-2" onclick="selectContest('demo-2', 'Thursday Night Football', this)">
                            <div class="contest-name">Thursday Night Football</div>
                            <div class="contest-details">18 players • $50,000</div>
                            <div class="contest-details" style="color: #ffff00;">STARTING SOON</div>
                        </div>
                    `;
          }
        } catch (error) {
          document.getElementById('contest-list').innerHTML =
            '<div style="color: #ff6666; text-align: center; padding: 20px;">Failed to load contests</div>';
        }
      }

      function selectContest(slateId, contestName, element) {
        document
          .querySelectorAll('.contest-item')
          .forEach(item => item.classList.remove('selected'));
        element.classList.add('selected');

        selectedSlateId = slateId;
        document.getElementById('selected-contest').textContent = contestName;
        loadPlayers(slateId);
      }

      async function loadPlayers(slateId) {
        const playerGrid = document.getElementById('player-grid');
        playerGrid.innerHTML =
          '<div style="text-align: center; padding: 50px; opacity: 0.6;">Loading player data...</div>';

        try {
          const response = await fetchWithAuth(`${API_BASE}/slates/${slateId}/players`);
          const data = await response.json();

          if (data.players && data.players.length > 0) {
            currentPlayers = data.players;
            document.getElementById('total-players').textContent = data.players.length;

            // Calculate market analytics
            const avgSalary =
              data.players.reduce((sum, p) => sum + (p.salary || 0), 0) /
              data.players.length;
            const topValue = Math.max(
              ...data.players.map(p => (p.projection * 1000) / p.salary || 0)
            );
            const chalkPlay = data.players.reduce(
              (prev, curr) =>
                (curr.ownership || 0) > (prev.ownership || 0) ? curr : prev,
              data.players[0]
            );

            document.getElementById('avg-salary').textContent =
              '$' + avgSalary.toFixed(0);
            document.getElementById('top-value').textContent =
              topValue.toFixed(1) + 'x';
            document.getElementById('chalk-play').textContent =
              chalkPlay.display_name || chalkPlay.name || 'N/A';

            playerGrid.innerHTML = `
                        <table class="player-table">
                            <thead>
                                <tr>
                                    <th>PLAYER</th>
                                    <th>POS</th>
                                    <th>TEAM</th>
                                    <th>SAL</th>
                                    <th>PROJ</th>
                                    <th>VAL</th>
                                    <th>OWN%</th>
                                    <th>CEIL</th>
                                    <th>FLR</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.players
                                  .slice(0, 100)
                                  .map(player => {
                                    const value =
                                      (player.projection * 1000) / player.salary || 0;
                                    const valueClass =
                                      value >= 2.5
                                        ? 'value-good'
                                        : value >= 2.0
                                          ? 'value-ok'
                                          : 'value-poor';

                                    return `
                                        <tr>
                                            <td style="font-weight: 500;">${player.display_name || player.name}</td>
                                            <td><strong>${player.position}</strong></td>
                                            <td>${player.team_abbreviation || player.team}</td>
                                            <td>$${(player.salary || 0).toLocaleString()}</td>
                                            <td>${(player.projection || 0).toFixed(1)}</td>
                                            <td class="${valueClass}">${value.toFixed(2)}</td>
                                            <td>${((player.ownership || 0) * 100).toFixed(1)}%</td>
                                            <td>${((player.projection || 0) * 1.3).toFixed(1)}</td>
                                            <td>${((player.projection || 0) * 0.7).toFixed(1)}</td>
                                        </tr>
                                    `;
                                  })
                                  .join('')}
                            </tbody>
                        </table>
                    `;
          } else {
            playerGrid.innerHTML =
              '<div style="color: #ff6666; text-align: center; padding: 50px;">No players available</div>';
          }
        } catch (error) {
          playerGrid.innerHTML =
            '<div style="color: #ff6666; text-align: center; padding: 50px;">Error loading players</div>';
        }
      }

      async function runOptimization() {
        if (!selectedSlateId || !currentPlayers.length) {
          alert('Select a contest first');
          return;
        }

        const btn = document.getElementById('optimize-btn');
        btn.disabled = true;
        btn.textContent = 'PROCESSING...';

        const resultsDiv = document.getElementById('lineup-results');
        resultsDiv.innerHTML =
          '<div style="text-align: center; padding: 20px; opacity: 0.6;">Generating optimal lineups...</div>';

        try {
          const optimizationRequest = {
            slateId: selectedSlateId,
            players: currentPlayers.slice(0, 50),
            constraints: {
              numLineups: parseInt(document.getElementById('num-lineups').value) || 20,
              salaryCapMode: 'hard',
              salaryCap: 50000,
              uniquePlayers: parseInt(document.getElementById('uniqueness').value) || 6,
              minSalary: parseInt(document.getElementById('min-salary').value) || 49000,
              maxSalary: 50000,
            },
          };

          const response = await fetchWithAuth(`${API_BASE}/optimize`, {
            method: 'POST',
            body: JSON.stringify(optimizationRequest),
          });

          const result = await response.json();

          if (result.lineups && result.lineups.length > 0) {
            document.getElementById('total-lineups').textContent =
              result.lineups.length;

            resultsDiv.innerHTML = result.lineups
              .slice(0, 8)
              .map(
                (lineup, index) => `
                        <div class="lineup-card">
                            <div class="lineup-header">
                                <span class="lineup-id">L${(index + 1).toString().padStart(3, '0')}</span>
                                <span class="lineup-score">${lineup.projectedScore?.toFixed(1) || '140.0'}</span>
                            </div>
                            <div style="font-size: 10px; margin-bottom: 8px;">
                                Salary: $${lineup.totalSalary?.toLocaleString() || '50,000'} | 
                                ROI: <span class="value-good">${lineup.roi?.toFixed(0) || '15'}%</span>
                            </div>
                            <div class="lineup-players">
                                ${
                                  lineup.players
                                    ?.slice(0, 9)
                                    .map(
                                      player => `
                                    <div class="player-line">
                                        <span>${(player.playerName || player.name || '').substring(0, 12)}</span>
                                        <span style="opacity: 0.7;">${player.projectedPoints?.toFixed(1) || '15.0'}</span>
                                    </div>
                                `
                                    )
                                    .join('') || ''
                                }
                            </div>
                        </div>
                    `
              )
              .join('');
          } else {
            resultsDiv.innerHTML =
              '<div style="color: #ff6666; text-align: center; padding: 20px;">No lineups generated</div>';
          }
        } catch (error) {
          resultsDiv.innerHTML =
            '<div style="color: #ff6666; text-align: center; padding: 20px;">Optimization failed</div>';
        } finally {
          btn.disabled = false;
          btn.textContent = 'Execute Optimization';
        }
      }

      async function checkApiHealth() {
        try {
          const response = await fetchWithAuth(`${API_BASE}/healthz`);
          const health = await response.json();

          if (health.ok || response.ok) {
            document.getElementById('api-connection').textContent = 'API ONLINE';
            document.getElementById('api-connection').style.color = '#00ff00';
          } else {
            throw new Error('API not healthy');
          }
        } catch (error) {
          document.getElementById('api-connection').textContent = 'API OFFLINE';
          document.getElementById('api-connection').style.color = '#ff6666';
        }
      }

      // Initialize
      window.addEventListener('DOMContentLoaded', () => {
        loadContests();
        checkApiHealth();
        updateTime();

        // Update time every second
        setInterval(updateTime, 1000);

        // Check API health every 30 seconds
        setInterval(checkApiHealth, 30000);
      });
    </script>
  </body>
</html>
