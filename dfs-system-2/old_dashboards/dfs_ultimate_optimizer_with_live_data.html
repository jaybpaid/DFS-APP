<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DFS Ultimate Optimizer - Live Data Integration</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <style>
        :root {
            --dk-blue: #53d337;
            --fd-blue: #1e3a8a;
            --primary: #2563eb;
            --secondary: #059669;
            --accent: #f59e0b;
            --dark: #0f172a;
            --pro-blue: #1e40af;
            --pro-green: #059669;
            --pro-purple: #7c3aed;
            --pro-orange: #ea580c;
            --pro-red: #dc2626;
            --card-bg: #ffffff;
            --light: #f8fafc;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--gray-50);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            line-height: 1.6;
            color: var(--gray-900);
            margin: 0;
            padding: 0;
        }

        .container-fluid {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 15px;
        }

        /* Enhanced Header with Live Slate Info */
        .main-header {
            background: linear-gradient(135deg, var(--dark) 0%, #1e293b 100%);
            color: white;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border-radius: 0 0 24px 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .slate-info-bar {
            background: rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 1rem;
            margin-top: 1rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
        }

        .slate-stat {
            text-align: center;
            padding: 0.5rem;
        }

        .slate-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--dk-blue);
        }

        .slate-stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* Live Data Status */
        .live-data-status {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            border: 2px solid var(--dk-blue);
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .status-live {
            background: var(--secondary);
            animation: pulse 2s infinite;
        }

        .status-offline {
            background: #ef4444;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Contest Cards */
        .contest-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .contest-card {
            background: white;
            border-radius: 16px;
            border: 2px solid transparent;
            overflow: hidden;
            transition: all 0.3s;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .contest-card.dk {
            border-color: var(--dk-blue);
        }

        .contest-card.fd {
            border-color: var(--fd-blue);
        }

        .contest-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
        }

        .contest-header {
            padding: 1rem;
            font-weight: 700;
            color: white;
        }

        .contest-header.dk {
            background: linear-gradient(135deg, var(--dk-blue), #22c55e);
        }

        .contest-header.fd {
            background: linear-gradient(135deg, var(--fd-blue), #3b82f6);
        }

        .contest-body {
            padding: 1rem;
        }

        /* Multi-Source Data Display */
        .data-sources {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e5e7eb;
        }

        .source-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .source-tab {
            background: #f1f5f9;
            border: 1px solid #d1d5db;
            padding: 0.5rem 1rem;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .source-tab.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .source-content {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            min-height: 120px;
        }

        /* Enhanced Player Cards */
        .player-enhanced-card {
            background: white;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            margin-bottom: 0.8rem;
            transition: all 0.3s;
            position: relative;
        }

        .player-enhanced-card:hover {
            border-color: var(--primary);
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.15);
        }

        .player-enhanced-card.locked {
            border-color: var(--secondary);
            background: linear-gradient(135deg, #ecfdf5, #d1fae5);
        }

        .player-enhanced-card.banned {
            border-color: #ef4444;
            background: linear-gradient(135deg, #fef2f2, #fee2e2);
        }

        .multi-source-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: var(--accent);
            color: white;
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        /* Advanced Projections Display */
        .projection-breakdown {
            background: #f0f9ff;
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            border: 1px solid rgba(37, 99, 235, 0.2);
        }

        .projection-item {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            margin-bottom: 2px;
        }

        .projection-item:last-child {
            margin-bottom: 0;
        }

        /* Advanced Metrics Display */
        .advanced-metrics {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.3rem;
            margin-top: 0.5rem;
        }

        .metric-item {
            text-align: center;
            padding: 0.3rem;
            background: #f8fafc;
            border-radius: 4px;
        }

        .metric-value {
            font-weight: 700;
            color: var(--pro-blue);
            font-size: 0.8rem;
        }

        .metric-label {
            font-size: 0.6rem;
            color: #6b7280;
            text-transform: uppercase;
        }

        /* Professional Control Grid */
        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .control-panel {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .panel-header {
            background: linear-gradient(135deg, var(--pro-blue), var(--pro-purple));
            color: white;
            padding: 0.8rem;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .panel-content {
            padding: 1rem;
        }

        /* Simulation Dashboard */
        .sim-dashboard {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .sim-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--pro-orange);
        }

        /* Professional Tabbed Layout */
        .main-dashboard {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .dashboard-tabs {
            background: linear-gradient(135deg, var(--pro-blue), var(--pro-purple));
            padding: 0;
            margin: 0;
            display: flex;
            overflow-x: auto;
        }

        .dashboard-tab {
            background: none;
            border: none;
            color: rgba(255,255,255,0.8);
            padding: 1rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
            white-space: nowrap;
        }

        .dashboard-tab:hover {
            color: white;
            background: rgba(255,255,255,0.1);
        }

        .dashboard-tab.active {
            color: white;
            background: rgba(255,255,255,0.15);
            border-bottom-color: white;
        }

        .tab-content {
            padding: 2rem;
            min-height: 600px;
        }

        /* Advanced Visualizations */
        .chart-container {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border: 1px solid #e5e7eb;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .metric-chart {
            height: 300px;
            position: relative;
        }

        /* Real-time Alerts */
        .alerts-panel {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .alert-item {
            background: white;
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--accent);
        }

        /* Portfolio Optimization */
        .portfolio-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .portfolio-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
            text-align: center;
        }

        .portfolio-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--pro-green);
        }

        /* Source Attribution */
        .source-attribution {
            background: #f8fafc;
            border-radius: 8px;
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
        }

        .source-badge {
            display: inline-block;
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-right: 4px;
            font-size: 0.7rem;
        }

        /* Enhanced Lineup Analysis */
        .lineup-comparison {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .comparison-card {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }

        /* Layout */
        .enhanced-grid {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 2rem;
        }

        .split-screen {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            min-height: 80vh;
        }

        .player-pool-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        .lineup-analysis-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Lineup Cards */
        .lineup-pro-card {
            background: var(--card-bg);
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            margin-bottom: 1rem;
            overflow: hidden;
            transition: all 0.3s;
        }

        .lineup-pro-card:hover {
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .lineup-header {
            background: linear-gradient(135deg, var(--pro-green), var(--pro-blue));
            color: white;
            padding: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .lineup-metrics {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            padding: 0.5rem 0.8rem;
            background: #f8fafc;
        }

        /* Late Swap Panel */
        .late-swap-panel {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            border: 1px solid rgba(245, 158, 11, 0.3);
        }

        .swap-recommendation {
            background: white;
            border-radius: 8px;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--secondary);
        }

        /* Portfolio Analysis */
        .portfolio-analysis {
            background: linear-gradient(135deg, #e0f2fe, #b3e5fc);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        /* Form Enhancements */
        .form-control, .form-select {
            border-radius: 8px;
            border: 1.5px solid #d1d5db;
            font-size: 0.9rem;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--pro-blue);
            box-shadow: 0 0 0 0.2rem rgba(30, 64, 175, 0.1);
        }

        .btn-pro-primary {
            background: linear-gradient(135deg, var(--pro-blue), var(--pro-purple));
            border: none;
            color: white;
        }

        .btn-pro-success {
            background: linear-gradient(135deg, var(--pro-green), #10b981);
            border: none;
            color: white;
        }

        /* Loading States */
        .loading-spinner {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100px;
        }

        /* Sport Pills */
        .sport-pill {
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .sport-pill:hover {
            background: rgba(255,255,255,0.3);
        }

        .sport-pill.active {
            background: white;
            color: var(--dark);
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f0f9ff;
        }

        .upload-area-small {
            display: inline-block;
            padding: 0.5rem;
        }

        /* Workflow Steps */
        .workflow-steps {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }

        .steps-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .step-item {
            display: flex;
            align-items: center;
            padding: 0.5rem;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .step-number {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            margin-right: 0.5rem;
            flex-shrink: 0;
        }

        .step-text {
            font-size: 0.8rem;
            line-height: 1.2;
        }

        /* Workflow Status */
        .workflow-status {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }

        .status-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            font-size: 0.9rem;
        }

        .status-item.active i {
            color: var(--secondary) !important;
        }

        .status-item.completed i {
            color: var(--primary) !important;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .enhanced-grid {
                grid-template-columns: 1fr;
            }
            .split-screen {
                grid-template-columns: 1fr;
                gap: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Live Data Status Indicator -->
    <div class="live-data-status">
        <div class="d-flex align-items-center mb-2">
            <div class="status-indicator status-offline" id="dataStatusIndicator"></div>
            <span class="fw-bold" id="dataStatusText">Connecting to Live Data...</span>
        </div>
        <div class="small text-muted" id="lastUpdateTime">--</div>
        <div class="small text-muted" id="dataSourceInfo">--</div>
    </div>

    <!-- Enhanced Header with Live Slate Info -->
    <div class="main-header">
        <div class="container-fluid">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="mb-0"><i class="fas fa-satellite-dish me-2"></i>DFS Ultimate Optimizer</h1>
                    <p class="mb-0 opacity-75">Live Data Integration - Professional Platform</p>
                </div>
                <div class="d-flex gap-3">
                    <div class="sport-pill active" data-sport="NFL">üèà NFL</div>
                    <div class="sport-pill" data-sport="NBA">üèÄ NBA</div>
                </div>
            </div>

            <!-- Live Slate Information Bar -->
            <div class="slate-info-bar" id="slateInfoBar">
                <div class="slate-stat">
                    <div class="slate-stat-value" id="totalGames">0</div>
                    <div class="slate-stat-label">Games</div>
                </div>
                <div class="slate-stat">
                    <div class="slate-stat-value" id="totalPlayers">0</div>
                    <div class="slate-stat-label">Players</div>
                </div>
                <div class="slate-stat">
                    <div class="slate-stat-value" id="avgSalary">$0</div>
                    <div class="slate-stat-label">Avg Salary</div>
                </div>
                <div class="slate-stat">
                    <div class="slate-stat-value" id="sourcesScraped">0</div>
                    <div class="slate-stat-label">Sources</div>
                </div>
                <div class="slate-stat">
                    <div class="slate-stat-value" id="lastUpdated">--</div>
                    <div class="slate-stat-label">Last Update</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Navigation Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark border-bottom">
        <div class="container-fluid">
            <a class="navbar-brand fw-bold" href="#">
                <i class="fas fa-satellite-dish me-2 text-primary"></i>
                DFS Ultimate Optimizer
            </a>

            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>

            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link active" href="#" data-section="players">
                            <i class="fas fa-users me-1"></i>Players
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="lineups">
                            <i class="fas fa-th-list me-1"></i>Lineups
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="contests">
                            <i class="fas fa-trophy me-1"></i>Contests
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="analysis">
                            <i class="fas fa-chart-bar me-1"></i>Analysis
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" data-section="research">
                            <i class="fas fa-flask me-1"></i>Research
                        </a>
                    </li>
                </ul>

                <div class="d-flex align-items-center">
                    <div class="sport-selector me-3">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="sport" id="nfl" autocomplete="off" checked>
                            <label class="btn btn-outline-light btn-sm" for="nfl">NFL</label>
                            <input type="radio" class="btn-check" name="sport" id="nba" autocomplete="off">
                            <label class="btn btn-outline-light btn-sm" for="nba">NBA</label>
                        </div>
                    </div>

                    <div class="status-indicator me-3">
                        <span class="badge bg-success" id="connectionStatus">
                            <i class="fas fa-circle me-1"></i>Live
                        </span>
                    </div>

                    <button class="btn btn-primary btn-sm" id="loadLiveDataBtn">
                        <i class="fas fa-sync-alt me-1"></i>Load Data
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <!-- Alert Area -->
        <div id="alertArea" class="mt-3"></div>

        <!-- Enhanced Slate Selector Section -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-trophy me-2"></i>Contest Slate Selector
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Select Date</label>
                                <input type="date" class="form-control" id="slateDate" />
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-bold">Select Site</label>
                                <select class="form-select" id="siteSelector">
                                    <option value="draftkings">DraftKings</option>
                                    <option value="fanduel">FanDuel</option>
                                    <option value="superdraft">SuperDraft</option>
                                </select>
                            </div>
                        </div>
                        
                        <label class="form-label fw-bold">Available Slates for Selected Date</label>
                        <select class="form-select mb-3" id="slateSelector" size="6">
                            <option value="">Select date and site to load slates...</option>
                        </select>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-secondary btn-sm" id="refreshSlatesBtn">
                                <i class="fas fa-sync-alt me-1"></i>Refresh Slates
                            </button>
                            <button class="btn btn-info btn-sm" id="loadAllSlatesBtn">
                                <i class="fas fa-calendar-day me-1"></i>Load All Today
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="contest-details-panel" id="contestDetailsPanel">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-info-circle fa-2x mb-2"></i>
                                <p>Select a slate to see contest details</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Enhanced CSV Upload & Late-Swap Workflow -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <i class="fas fa-exchange-alt me-2"></i>DraftKings CSV Upload & Late-Swap Workflow
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-8">
                        <div class="workflow-steps mb-3">
                            <h6><i class="fas fa-route me-2"></i>Complete Late-Swap Workflow (Like Stokastic)</h6>
                            <div class="steps-container">
                                <div class="step-item">
                                    <span class="step-number">1</span>
                                    <span class="step-text">Upload your DraftKings contest CSV (your entries/lineups)</span>
                                </div>
                                <div class="step-item">
                                    <span class="step-number">2</span>
                                    <span class="step-text">Build updated field pool with current projections & ownership</span>
                                </div>
                                <div class="step-item">
                                    <span class="step-number">3</span>
                                    <span class="step-text">Auto-generate swappable lineup variants & simulate (40K+ times)</span>
                                </div>
                                <div class="step-item">
                                    <span class="step-number">4</span>
                                    <span class="step-text">Export optimized lineups back to DraftKings-compatible CSV</span>
                                </div>
                            </div>
                        </div>

                        <div class="upload-area" id="uploadArea">
                            <i class="fas fa-file-csv fa-3x mb-3 text-primary"></i>
                            <h5>Upload Your DraftKings Contest CSV</h5>
                            <p class="text-muted">Upload your existing DraftKings entries for late-swap optimization</p>
                            <input type="file" id="dkContestFile" accept=".csv" style="display: none;">
                            <button class="btn btn-primary btn-lg mb-2" onclick="document.getElementById('dkContestFile').click()">
                                <i class="fas fa-upload me-2"></i>Upload DK Contest CSV
                            </button>
                            <div class="small text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Supports DraftKings contest CSV format with your existing lineups
                            </div>
                        </div>

                        <div class="alternative-upload mt-3">
                            <hr>
                            <h6>Alternative: Upload Salary File</h6>
                            <div class="upload-area-small" id="salaryUploadArea">
                                <input type="file" id="salaryFile" accept=".csv" style="display: none;">
                                <button class="btn btn-outline-secondary" onclick="document.getElementById('salaryFile').click()">
                                    <i class="fas fa-dollar-sign me-2"></i>Upload Salary CSV
                                </button>
                                <span class="small text-muted ms-2">For building new lineups from scratch</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="workflow-status mb-3">
                            <h6><i class="fas fa-tasks me-2"></i>Workflow Status</h6>
                            <div class="status-item" id="step1Status">
                                <i class="fas fa-circle text-muted me-2"></i>
                                <span>CSV Upload</span>
                            </div>
                            <div class="status-item" id="step2Status">
                                <i class="fas fa-circle text-muted me-2"></i>
                                <span>Field Modeling</span>
                            </div>
                            <div class="status-item" id="step3Status">
                                <i class="fas fa-circle text-muted me-2"></i>
                                <span>Simulation & Swaps</span>
                            </div>
                            <div class="status-item" id="step4Status">
                                <i class="fas fa-circle text-muted me-2"></i>
                                <span>Export Ready</span>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button class="btn btn-success btn-lg" id="runLateSwapBtn" disabled>
                                <i class="fas fa-magic me-2"></i>Run Late-Swap Analysis
                            </button>
                            <button class="btn btn-warning" id="simulateFieldBtn" disabled>
                                <i class="fas fa-chart-line me-2"></i>Simulate vs Field (40K)
                            </button>
                            <button class="btn btn-info" id="exportOptimizedBtn" disabled>
                                <i class="fas fa-download me-2"></i>Export to DraftKings
                            </button>
                            <div class="small text-muted mt-2">
                                <i class="fas fa-lightbulb me-1"></i>
                                Upload your DK contest CSV to unlock late-swap workflow
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Multi-Source Data Panel -->
        <div class="data-sources">
            <h4><i class="fas fa-database me-2"></i>Multi-Source Intelligence</h4>
            <div class="source-tabs" id="sourceTabs">
                <div class="source-tab active" data-source="draftkings">DraftKings Live</div>
                <div class="source-tab" data-source="rotowire">RotoWire</div>
                <div class="source-tab" data-source="pff">Pro Football Focus</div>
                <div class="source-tab" data-source="sports_info_solutions">Sports Info Solutions</div>
                <div class="source-tab" data-source="fantasy_footballers">Fantasy Footballers</div>
                <div class="source-tab" data-source="ai_analysis">AI Analysis</div>
            </div>
            <div class="source-content" id="sourceContent">
                <div class="text-muted">
                    <i class="fas fa-spinner fa-spin me-2"></i>Loading live multi-source data...
                </div>
            </div>
        </div>

        <!-- Advanced Controls -->
        <div class="controls-grid">
            <!-- Advanced Settings -->
            <div class="control-panel">
                <div class="panel-header">
                    <i class="fas fa-cogs me-2"></i>Advanced Settings
                </div>
                <div class="panel-content">
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Lineups to Generate</label>
                            <input type="number" class="form-control" id="numLineups" value="20" min="1" max="500">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Contest Type</label>
                            <select class="form-select" id="contestType">
                                <option value="gpp">Tournament (GPP)</option>
                                <option value="cash">Cash Game</option>
                            </select>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Randomness Level</label>
                            <input type="range" class="form-range" id="randomness" min="0" max="50" value="15">
                            <span class="range-value" id="randomnessValue">15%</span>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Contrarian Level</label>
                            <input type="range" class="form-range" id="contrarian" min="0" max="80" value="25">
                            <span class="range-value" id="contrarianValue">25%</span>
                        </div>
                    </div>

                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="aiOptimization" checked>
                        <label class="form-check-label">AI-Driven Player Selection</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="exposureControls" checked>
                        <label class="form-check-label">Smart Exposure Controls</label>
                    </div>
                </div>
            </div>

            <!-- Late Swap Panel -->
            <div class="control-panel">
                <div class="panel-header">
                    <i class="fas fa-exchange-alt me-2"></i>Late Swap Engine
                </div>
                <div class="panel-content">
                    <div class="late-swap-panel" id="lateSwapPanel" style="display: none;">
                        <h6><i class="fas fa-lightbulb me-2"></i>AI Swap Recommendations</h6>
                        <div id="swapRecommendations">
                            <div class="text-center text-muted">
                                <i class="fas fa-brain fa-2x mb-2"></i>
                                <p>Generate lineups first to see late swap opportunities</p>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Locked Players (comma-separated)</label>
                        <input type="text" class="form-control" id="lockedPlayers" placeholder="e.g., Josh Allen, CMC, Davante Adams">
                    </div>

                    <button class="btn btn-warning w-100" id="calculateLateSwapBtn" disabled>
                        <i class="fas fa-magic me-2"></i>Calculate Late Swaps
                    </button>
                </div>
            </div>

            <!-- Simulation Results -->
            <div class="control-panel">
                <div class="panel-header">
                    <i class="fas fa-chart-line me-2"></i>Contest Simulation
                </div>
                <div class="panel-content">
                    <div class="sim-dashboard" id="simulationResults" style="display: none;">
                        <div class="row mb-2">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="sim-value" id="simRuns">50K</div>
                                    <div class="sim-label">Simulations</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="sim-value" id="avgROI">0%</div>
                                    <div class="sim-label">Avg ROI</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="sim-value" id="winRate">0%</div>
                                    <div class="sim-label">Win Rate</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <div class="sim-value" id="sharpeRatio">0.0</div>
                                    <div class="sim-label">Sharpe</div>
                                </div>
                            </div>
                        </div>
                        <small class="text-center d-block text-muted">Monte Carlo analysis of expected performance</small>
                    </div>

                    <div id="simulationMessage" class="text-center">
                        <button class="btn btn-pro-primary w-100" id="runSimBtn">
                            <i class="fas fa-play me-2"></i>Run Advanced Simulation
                        </button>
                    </div>
                </div>
            </div>

            <!-- AI Strategy Results -->
            <div class="control-panel">
                <div class="panel-header">
                    <i class="fas fa-robot me-2"></i>AI Strategy Analysis
                </div>
                <div class="panel-content">
                    <select class="form-select mb-3" id="aiModelSelect">
                        <option value="gpt4">GPT-4 (Strategic Narrative)</option>
                        <option value="claude">Claude (Statistical Analysis)</option>
                        <option value="deepseek">DeepSeek (Hybrid Approach)</option>
                    </select>
                    <div id="aiStrategyResults" class="mb-3">
                        <div class="text-center text-muted">
                            <i class="fas fa-brain fa-2x mb-2"></i>
                            <p>Click Get AI Strategy for professional analysis</p>
                        </div>
                    </div>
                    <button class="btn btn-pro-success w-100" id="getAIStrategyBtn">
                        Get AI Strategy
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Content Sections -->
        <div class="content-section active" id="players-section">
            <!-- Players Section Header -->
            <div class="section-header d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">NFL Player Database</h2>
                    <p class="text-muted mb-0">Multi-source projections and ownership data</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-secondary btn-sm" id="exportPlayersBtn">
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                    <button class="btn btn-primary btn-sm" id="refreshPlayersBtn">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                </div>
            </div>

            <!-- Advanced Filters -->
            <div class="filters-panel card mb-4">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Position</label>
                            <select class="form-select form-select-sm" id="positionFilter">
                                <option value="ALL">All Positions</option>
                                <option value="QB">QB</option>
                                <option value="RB">RB</option>
                                <option value="WR">WR</option>
                                <option value="TE">TE</option>
                                <option value="FLEX">FLEX</option>
                                <option value="DST">DST</option>
                                <option value="K">K</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Search Players</label>
                            <input type="text" class="form-control form-control-sm" id="nameFilter" placeholder="Player name...">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Min Salary</label>
                            <input type="number" class="form-control form-control-sm" id="minSalaryFilter" placeholder="0">
                        </div>
                        <div class="col-md-2">
                            <label class="form-label fw-bold">Max Salary</label>
                            <input type="number" class="form-control form-control-sm" id="maxSalaryFilter" placeholder="50000">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Sort By</label>
                            <select class="form-select form-select-sm" id="sortBy">
                                <option value="projection">Projection</option>
                                <option value="salary">Salary</option>
                                <option value="ownership">Ownership</option>
                                <option value="value">Value</option>
                                <option value="leverage">Leverage</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Min Projection</label>
                            <input type="number" class="form-control form-control-sm" id="minProjectionFilter" placeholder="0" step="0.1">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Max Ownership %</label>
                            <input type="number" class="form-control form-control-sm" id="maxOwnershipFilter" placeholder="100" max="100">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label fw-bold">Data Sources</label>
                            <select class="form-select form-select-sm" id="sourceFilter">
                                <option value="all">All Sources</option>
                                <option value="draftkings">DraftKings</option>
                                <option value="rotogrinders">RotoGrinders</option>
                                <option value="sabersim">SaberSim</option>
                                <option value="stokastic">Stokastic</option>
                                <option value="pff">PFF</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-outline-danger btn-sm me-2" id="clearFiltersBtn">
                                <i class="fas fa-times me-1"></i>Clear
                            </button>
                            <button class="btn btn-success btn-sm" id="applyFiltersBtn">
                                <i class="fas fa-filter me-1"></i>Apply
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Players Data Table -->
            <div class="card">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Player Projections & Ownership</h5>
                    <div class="d-flex gap-2">
                        <span class="badge bg-primary" id="totalPlayersBadge">0 Players</span>
                        <span class="badge bg-success" id="lastUpdateBadge">--</span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm mb-0" id="playersTable">
                            <thead class="table-dark">
                                <tr>
                                    <th class="text-center" style="width: 40px;">
                                        <input type="checkbox" id="selectAllPlayers">
                                    </th>
                                    <th style="width: 200px;">Player</th>
                                    <th class="text-center" style="width: 80px;">Pos</th>
                                    <th class="text-center" style="width: 100px;">Team</th>
                                    <th class="text-center" style="width: 100px;">Salary</th>
                                    <th class="text-center" style="width: 100px;">Projection</th>
                                    <th class="text-center" style="width: 100px;">Ownership</th>
                                    <th class="text-center" style="width: 100px;">Value</th>
                                    <th class="text-center" style="width: 100px;">Leverage</th>
                                    <th class="text-center" style="width: 120px;">
                                        <div>AI Good Day</div>
                                        <small class="text-muted">Score</small>
                                    </th>
                                    <th class="text-center" style="width: 120px;">Sources</th>
                                    <th class="text-center" style="width: 120px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="playersTableBody">
                                <tr>
                                    <td colspan="11" class="text-center py-5">
                                        <i class="fas fa-satellite-dish fa-3x mb-3 text-muted"></i>
                                        <h5 class="text-muted">Loading Live Player Data...</h5>
                                        <p class="text-muted mb-0">Connecting to DraftKings API and multi-source intelligence</p>
                                        <div class="spinner-border text-primary mt-3" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Lineups Section -->
        <div class="content-section" id="lineups-section">
            <div class="section-header d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 class="mb-0">Lineup Optimizer</h2>
                    <p class="text-muted mb-0">AI-powered lineup generation with multi-source intelligence</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-success" id="generateLineupsBtn">
                        <i class="fas fa-magic me-1"></i>Generate Lineups
                    </button>
                    <button class="btn btn-outline-primary" id="exportLineupsBtn" disabled>
                        <i class="fas fa-download me-1"></i>Export
                    </button>
                </div>
            </div>

            <!-- Lineup Generation Controls -->
            <div class="row mb-4">
                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Optimization Settings</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Strategy</label>
                                    <select class="form-select" id="objectiveSelect">
                                        <option value="ev">Expected Value</option>
                                        <option value="leverage">Ownership Leverage</option>
                                        <option value="ceiling">Ceiling Upside</option>
                                        <option value="sharpe">Sharpe Ratio</option>
                                        <option value="cash">Cash Game</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Lineups</label>
                                    <input type="number" class="form-control" id="numLineups" value="20" min="1" max="150">
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label fw-bold">Contest Size</label>
                                    <select class="form-select" id="fieldSizeSelect">
                                        <option value="100000">Large (100K+)</option>
                                        <option value="50000">Medium (50K)</option>
                                        <option value="10000">Small (10K)</option>
                                        <option value="1000">Mini (1K)</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label fw-bold">Randomness</label>
                                    <input type="range" class="form-range" id="randomness" min="0" max="50" value="15">
                                    <span class="range-value" id="randomnessValue">15%</span>
                                </div>
                                <div class="col-md-2 d-flex align-items-end">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="aiOptimization" checked>
                                        <label class="form-check-label small">AI Boost</label>
                                    </div>
                                </div>
                            </div>

                            <div class="row g-3 mt-2">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Locked Players</label>
                                    <input type="text" class="form-control" id="lockedPlayers" placeholder="e.g., Josh Allen, CMC, Davante Adams">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Banned Players</label>
                                    <input type="text" class="form-control" id="bannedPlayers" placeholder="Players to exclude">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Quick Stats</h5>
                        </div>
                        <div class="card-body">
                            <div class="row text-center g-3">
                                <div class="col-6">
                                    <div class="h4 text-primary mb-0" id="availablePlayers">0</div>
                                    <small class="text-muted">Available Players</small>
                                </div>
                                <div class="col-6">
                                    <div class="h4 text-success mb-0" id="generatedLineups">0</div>
                                    <small class="text-muted">Lineups Ready</small>
                                </div>
                            </div>
                            <hr>
                            <div class="small text-muted">
                                <div class="mb-1"><i class="fas fa-brain text-primary me-1"></i>AI analysis active</div>
                                <div class="mb-1"><i class="fas fa-database text-success me-1"></i>7 data sources</div>
                                <div class="mb-1"><i class="fas fa-chart-line text-warning me-1"></i>Monte Carlo ready</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Generated Lineups -->
            <div id="enhancedLineupsContainer">
                <div class="card">
                    <div class="card-body text-center py-5">
                        <i class="fas fa-magic fa-3x mb-3 text-muted"></i>
                        <h5 class="text-muted">Configure settings above and generate optimized lineups</h5>
                        <p class="text-muted mb-0">AI-powered optimization with multi-source intelligence</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Contests Section -->
        <div class="content-section" id="contests-section">
            <div class="section-header mb-4">
                <h2>NFL Contests</h2>
                <p class="text-muted mb-0">Live contest data and entry opportunities</p>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div id="contestGrid">
                        <div class="card">
                            <div class="card-body text-center py-5">
                                <i class="fas fa-trophy fa-3x mb-3 text-muted"></i>
                                <h5 class="text-muted">Loading Live Contest Data...</h5>
                                <p class="text-muted mb-0">Fetching DraftKings contests and entry options</p>
                                <div class="spinner-border text-primary mt-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Contest Filters</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Entry Fee Range</label>
                                <select class="form-select" id="entryFeeFilter">
                                    <option value="all">All Fees</option>
                                    <option value="free">$0 (Free)</option>
                                    <option value="low">$0.01 - $5</option>
                                    <option value="medium">$5 - $20</option>
                                    <option value="high">$20+</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Contest Size</label>
                                <select class="form-select" id="contestSizeFilter">
                                    <option value="all">All Sizes</option>
                                    <option value="small">1K - 10K</option>
                                    <option value="medium">10K - 100K</option>
                                    <option value="large">100K+</option>
                                </select>
                            </div>
                            <button class="btn btn-primary w-100" id="applyContestFiltersBtn">
                                <i class="fas fa-filter me-1"></i>Apply Filters
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Section -->
        <div class="content-section" id="analysis-section">
            <div class="section-header mb-4">
                <h2>Advanced Analysis</h2>
                <p class="text-muted mb-0">AI-powered insights and Monte Carlo simulations</p>
            </div>

            <div class="row">
                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">AI Strategy Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">AI Provider</label>
                                <select class="form-select" id="aiProviderSelect">
                                    <option value="gpt4">GPT-4 (Strategic Narrative)</option>
                                    <option value="claude">Claude (Statistical Analysis)</option>
                                    <option value="deepseek">DeepSeek (Hybrid Approach)</option>
                                </select>
                            </div>
                            <div id="aiAnalysisResults" class="mb-3">
                                <div class="text-center text-muted py-4">
                                    <i class="fas fa-brain fa-3x mb-3"></i>
                                    <p>Load player data to get AI-powered analysis</p>
                                </div>
                            </div>
                            <button class="btn btn-success w-100" id="getAIAnalysisBtn">
                                <i class="fas fa-brain me-1"></i>Get AI Analysis
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Correlation Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div id="correlationAnalysis" class="text-center py-4">
                                <i class="fas fa-chart-network fa-3x mb-3 text-muted"></i>
                                <p class="text-muted">Generate lineups to see player correlations</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Monte Carlo Simulation</h5>
                        </div>
                        <div class="card-body">
                            <div class="row g-3 mb-3">
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Simulations</label>
                                    <select class="form-select" id="simulationCount">
                                        <option value="10000">10K</option>
                                        <option value="50000">50K</option>
                                        <option value="100000">100K</option>
                                        <option value="500000">500K</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label fw-bold">Field Size</label>
                                    <select class="form-select" id="simulationFieldSize">
                                        <option value="100000">Large (100K+)</option>
                                        <option value="50000">Medium (50K)</option>
                                        <option value="10000">Small (10K)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="simulationResults" class="mb-3" style="display: none;">
                                <div class="row text-center g-3">
                                    <div class="col-6">
                                        <div class="h4 text-success mb-0" id="simAvgROI">0.0%</div>
                                        <small class="text-muted">Avg ROI</small>
                                    </div>
                                    <div class="col-6">
                                        <div class="h4 text-primary mb-0" id="simWinRate">0.0%</div>
                                        <small class="text-muted">Win Rate</small>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-warning w-100" id="runSimulationBtn">
                                <i class="fas fa-play me-1"></i>Run Simulation
                            </button>
                        </div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Ownership Projections</h5>
                        </div>
                        <div class="card-body">
                            <div id="ownershipProjections" class="text-center py-4">
                                <i class="fas fa-users fa-3x mb-3 text-muted"></i>
                                <p class="text-muted">Generate lineups to see ownership projections</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Research Section -->
        <div class="content-section" id="research-section">
            <div class="section-header mb-4">
                <h2>Research Tools</h2>
                <p class="text-muted mb-0">Deep dive into player trends and historical data</p>
            </div>

            <div class="row">
                <div class="col-lg-4">
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Player Trends</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Time Period</label>
                                <select class="form-select" id="trendPeriod">
                                    <option value="7">Last 7 days</option>
                                    <option value="30">Last 30 days</option>
                                    <option value="90">Last 90 days</option>
                                    <option value="season">Season</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label fw-bold">Metric</label>
                                <select class="form-select" id="trendMetric">
                                    <option value="projection">Projection</option>
                                    <option value="ownership">Ownership</option>
                                    <option value="value">Value</option>
                                    <option value="correlation">Correlation</option>
                                </select>
                            </div>
                            <button class="btn btn-info w-100" id="analyzeTrendsBtn">
                                <i class="fas fa-chart-line me-1"></i>Analyze Trends
                            </button>
                        </div>
                    </div>
                </div>

                <div class="col-lg-8">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">Research Results</h5>
                        </div>
                        <div class="card-body">
                            <div id="researchResults" class="text-center py-5">
                                <i class="fas fa-flask fa-3x mb-3 text-muted"></i>
                                <h5 class="text-muted">Research Tools</h5>
                                <p class="text-muted mb-0">Use the controls on the left to analyze player trends and historical data</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Professional Footer -->
    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-6">
                    <h6 class="mb-3">DFS Ultimate Optimizer</h6>
                    <p class="mb-0 small">Professional-grade DFS platform with live data integration and AI-powered analysis.</p>
                </div>
                <div class="col-md-6 text-end">
                    <div class="small text-muted mb-2">Data Sources: DraftKings, RotoGrinders, SaberSim, Stokastic, PFF, DFS Army</div>
                    <div class="small text-muted">Last updated: <span id="footerLastUpdate">--</span></div>
                </div>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net@1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@1.13.4/js/dataTables.bootstrap5.min.js"></script>

    <script>
        let ultimateState = {
            sport: 'NFL',
            site: 'DraftKings',
            slateData: {},
            players: [],
            lineups: [],
            currentSource: 'draftkings',
            aiProvider: 'gpt4',
            filters: { position: 'ALL', name: '', minSalary: '', maxSalary: '' },
            locked_players: [],
            banned_players: [],
            exposures: {},
            liveDataConnected: false,
            lastDataUpdate: null,
            dataRefreshInterval: null
        };

        $(document).ready(function() {
            setupEventListeners();
            setupFileUpload();
            setupSlateSelector();
            checkLiveDataConnection();
            showAlert('info', 'üöÄ DFS Ultimate Optimizer - Connecting to Live Data Sources...');
        });

        function setupEventListeners() {
            // Sport selection
            $('.sport-pill').click(function() {
                $('.sport-pill').removeClass('active');
                $(this).addClass('active');
                const sport = $(this).data('sport');
                switchSportWithLiveData(sport);
            });

            // Dashboard tabs
            $('.dashboard-tab').click(function() {
                const tabName = $(this).data('tab');
                switchDashboardTab(tabName);
            });

            // Source tabs
            $('.source-tab').click(function() {
                $('.source-tab').removeClass('active');
                $(this).addClass('active');
                const source = $(this).data('source');
                displaySourceData(source);
            });

            // Buttons
            $('#loadLiveDataBtn').click(loadLiveDraftKingsData);
            $('#refreshDataBtn').click(refreshLiveData);
            $('#quickLoadDataBtn').click(loadLiveDraftKingsData);
            $('#quickGenerateBtn').click(generateAdvancedLineups);
            $('#quickSimulateBtn').click(runContestSimulation);
            $('#quickExportBtn').click(exportEnhancedLineups);
            $('#getAIStrategyBtn').click(getEnhancedAIAnalysis);
            $('#runSimBtn').click(runContestSimulation);
            $('#generateLineupsBtn, #advancedGenerateBtn').click(generateAdvancedLineups);
            $('#autoSetExposuresBtn').click(autoSetExposures);
            $('#calculateLateSwapBtn').click(calculateLateSwaps);
            $('#exportLineupsBtn').click(exportEnhancedLineups);
            $('#clearAlertsBtn').click(clearAlerts);

            // AI provider selection
            $('#aiModelSelect').change(function() {
                ultimateState.aiProvider = $(this).val();
            });

            // Range sliders
            $('#randomness').on('input', function() {
                $('#randomnessValue').text($(this).val() + '%');
            });
            $('#contrarian').on('input', function() {
                $('#contrarianValue').text($(this).val() + '%');
            });

            // Filters
            $('#positionFilter').change(() => updateFilters());
            $('#nameFilter').on('input', () => updateFilters());
            $('#minSalaryFilter, #maxSalaryFilter').change(() => updateFilters());

            // Navigation section switching
            $('.nav-link[data-section]').click(function(e) {
                e.preventDefault();
                const section = $(this).data('section');
                switchSection(section);
            });
        }

        function switchSection(sectionName) {
            // Remove active class from all nav links and sections
            $('.nav-link').removeClass('active');
            $('.content-section').removeClass('active');

            // Add active class to selected nav link and section
            $(`.nav-link[data-section="${sectionName}"]`).addClass('active');
            $(`#${sectionName}-section`).addClass('active');

            // Update section-specific data if needed
            if (sectionName === 'players' && ultimateState.players.length > 0) {
                displayPlayersTable(ultimateState.players);
            } else if (sectionName === 'lineups' && ultimateState.lineups.length > 0) {
                displayEnhancedLineups(ultimateState.lineups);
            }
        }

        function displayPlayersTable(players) {
            const tbody = $('#playersTableBody');
            tbody.empty();

            if (players.length === 0) {
                tbody.html(`
                    <tr>
                        <td colspan="11" class="text-center py-5">
                            <i class="fas fa-satellite-dish fa-3x mb-3 text-muted"></i>
                            <h5 class="text-muted">No Player Data Available</h5>
                            <p class="text-muted mb-0">Load live data or upload a salary file to get started</p>
                        </td>
                    </tr>
                `);
                return;
            }

            const filteredPlayers = applyFilters(players);
            $('#totalPlayersBadge').text(`${filteredPlayers.length} Players`);
            $('#lastUpdateBadge').text(ultimateState.lastDataUpdate ? 
                new Date(ultimateState.lastDataUpdate).toLocaleTimeString() : '--');

            filteredPlayers.forEach(player => {
                const value = player.salary > 0 ? ((player.consensus_projection || player.projection || 0) / (player.salary / 1000)).toFixed(2) : 'N/A';
                const leverage = ((player.consensus_projection || player.projection || 0) / Math.max(player.ownership || player.rg_ownership || 1, 1)).toFixed(2);
                
                const row = $(`
                    <tr class="player-row" data-player-id="${player.id || player.name.replace(/\s+/g, '').toLowerCase()}">
                        <td class="text-center">
                            <input type="checkbox" class="player-checkbox" data-player-id="${player.id || player.name.replace(/\s+/g, '').toLowerCase()}">
                        </td>
                        <td>
                            <div class="fw-bold">${player.name}</div>
                            <small class="text-muted">${player.team || 'N/A'}</small>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-primary">${player.position}</span>
                        </td>
                        <td class="text-center">${player.team || 'N/A'}</td>
                        <td class="text-center">$${player.salary.toLocaleString()}</td>
                        <td class="text-center">${player.consensus_projection || player.projection || 'N/A'}</td>
                        <td class="text-center">${player.ownership || player.rg_ownership || 'N/A'}%</td>
                        <td class="text-center">${value}</td>
                        <td class="text-center">${leverage}</td>
                        <td class="text-center">
                            <div class="ai-score-display">
                                <div class="ai-score-value ${getAIScoreColor(player.ai_good_day_score || 0)}">
                                    ${player.ai_good_day_score || 'N/A'}
                                </div>
                                <div class="ai-score-confidence ${getAIConfidenceColor(player.ai_confidence_level || 'Low')}">
                                    ${player.ai_confidence_level || 'Low'}
                                </div>
                            </div>
                        </td>
                        <td class="text-center">
                            <span class="badge bg-info">${player.sources_count || 1}</span>
                        </td>
                        <td class="text-center">
                            <div class="btn-group btn-group-sm">
                                <button class="btn ${player.locked ? 'btn-success' : 'btn-outline-success'} lock-player-btn" data-player-id="${player.id || player.name.replace(/\s+/g, '').toLowerCase()}" title="Lock Player">
                                    <i class="fas fa-lock"></i>
                                </button>
                                <button class="btn ${player.banned ? 'btn-danger' : 'btn-outline-danger'} ban-player-btn" data-player-id="${player.id || player.name.replace(/\s+/g, '').toLowerCase()}" title="Ban Player">
                                    <i class="fas fa-ban"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `);
                tbody.append(row);
            });

            // Add event handlers for player actions
            $('.lock-player-btn').click(function() {
                const playerId = $(this).data('player-id');
                togglePlayerLock(playerId);
            });

            $('.ban-player-btn').click(function() {
                const playerId = $(this).data('player-id');
                togglePlayerBan(playerId);
            });

            $('.player-checkbox').change(function() {
                updateSelectedPlayers();
            });
        }

        function updateSelectedPlayers() {
            const selectedCount = $('.player-checkbox:checked').length;
            if (selectedCount > 0) {
                $('#exportPlayersBtn').prop('disabled', false);
            } else {
                $('#exportPlayersBtn').prop('disabled', true);
            }
        }

        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('salaryFile');

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = 'var(--pro-blue)';
                uploadArea.style.backgroundColor = '#f0f9ff';
            });

            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d1d5db';
                uploadArea.style.backgroundColor = '#fafafa';
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#d1d5db';
                uploadArea.style.backgroundColor = '#fafafa';

                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    uploadSalaryFile(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    uploadSalaryFile(e.target.files[0]);
                }
            });
        }

        async function checkLiveDataConnection() {
            try {
                const response = await fetch('http://localhost:8000/health');
                if (response.ok) {
                    ultimateState.liveDataConnected = true;
                    updateDataStatus(true, 'Live DFS Optimizer API Connected');
                    $('#loadLiveDataBtn').prop('disabled', false);
                    $('#refreshDataBtn').prop('disabled', false);

                    // Auto-load data if connected
                    setTimeout(() => {
                        loadLiveDraftKingsData();
                    }, 1000);

                    // Set up auto-refresh every 15 minutes
                    ultimateState.dataRefreshInterval = setInterval(() => {
                        refreshLiveData();
                    }, 15 * 60 * 1000);

                } else {
                    throw new Error('API server not responding');
                }
            } catch (error) {
                updateDataStatus(false, 'DFS Optimizer API Server Offline');
                $('#loadLiveDataBtn').prop('disabled', true);
                $('#refreshDataBtn').prop('disabled', true);
                showAlert('warning', '‚ö†Ô∏è DFS Optimizer API server not running. Start it with: python live_optimizer_api.py');
            }
        }

        function updateDataStatus(isLive, message) {
            const indicator = $('#dataStatusIndicator');
            const text = $('#dataStatusText');

            if (isLive) {
                indicator.removeClass('status-offline').addClass('status-live');
                text.text(message);
            } else {
                indicator.removeClass('status-live').addClass('status-offline');
                text.text(message);
            }

            $('#lastUpdateTime').text(ultimateState.lastDataUpdate ?
                new Date(ultimateState.lastDataUpdate).toLocaleTimeString() : '--');
        }

        async function loadLiveDraftKingsData() {
            if (!ultimateState.liveDataConnected) {
                showAlert('danger', 'Live data connection not available');
                return;
            }

            showLoading(`üîÑ Loading live ${ultimateState.sport} data and generating optimized lineups...`);

            try {
                // Call the new FastAPI endpoint for lineup generation
                const requestData = {
                    sport: ultimateState.sport,
                    site: ultimateState.site,
                    num_lineups: 20,
                    objective: 'ev',
                    contest_type: 'gpp',
                    locked_players: [],
                    banned_players: [],
                    max_exposure: 100.0,
                    force_refresh: false
                };

                const response = await fetch('http://localhost:8000/api/generate-lineups', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestData)
                });

                if (!response.ok) {
                    throw new Error(`API returned ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    // Check if we have player_pool data, otherwise generate full player set
                    if (data.player_pool && data.player_pool.length > 0) {
                        // Use the full player pool from API
                        ultimateState.players = data.player_pool.map(p => ({
                            id: p.id || p.name.replace(/\s+/g, '').toLowerCase(),
                            name: p.name,
                            position: p.position,
                            team: p.team,
                            salary: p.salary,
                            projection: p.projection || p.consensus_projection || 0,
                            ownership: p.ownership || p.rg_ownership || 0,
                            consensus_projection: p.consensus_projection || p.projection || 0,
                            rg_ownership: p.rg_ownership || p.ownership || 0,
                            leverage_score: p.leverage_score || 2.0,
                            boom_pct: p.boom_pct || 25,
                            floor: p.floor || (p.projection * 0.7),
                            ceiling: p.ceiling || (p.projection * 1.4),
                            correlation_score: p.correlation_score || 0.5,
                            volatility: p.volatility || 0.2,
                            sources_count: p.sources_count || 1,
                            locked: false,
                            banned: false,
                            exposure: 100,
                            value: p.value || ((p.projection || 0) / Math.max((p.salary || 1) / 1000, 1))
                        }));
                    } else {
                        // Fallback: Generate comprehensive player pool for the sport
                        console.log('No player_pool in API response, generating full player set');
                        ultimateState.players = generateEnhancedPlayers(ultimateState.sport);
                    }

                    ultimateState.lineups = data.lineups;
                    ultimateState.lastDataUpdate = new Date().toISOString();

                    // Update UI
                    updateSlateInfoBar(ultimateState.players);
                    displayContestsFromAPI(data);
                    displayEnhancedPlayers(ultimateState.players);
                    displaySourceData('draftkings');
                    displayEnhancedLineups(data.lineups);

                    updateDataStatus(true, `Live ${ultimateState.sport} Data & Lineups Generated`);
                    hideLoading();
                    showAlert('success', `‚úÖ Live optimization complete! ${data.total_lineups} lineups generated with real DraftKings data`);

                    $('#advancedGenerateBtn').prop('disabled', false);
                    $('#calculateLateSwapBtn').prop('disabled', false);
                    $('#portfolioAnalysis').show();
                    $('#lateSwapPanel').show();

                    // Enable quick action buttons
                    $('#quickGenerateBtn').prop('disabled', false);
                    $('#quickSimulateBtn').prop('disabled', false);
                    $('#quickExportBtn').prop('disabled', false);

                    // Update quick stats
                    updateQuickStats();

                } else {
                    throw new Error(data.error || 'Unknown API error');
                }

            } catch (error) {
                hideLoading();
                updateDataStatus(false, 'Optimization Failed');
                showAlert('danger', `Error running live optimization: ${error.message}`);
                console.error('Live optimization error:', error);
            }
        }

        async function refreshLiveData() {
            if (!ultimateState.liveDataConnected) {
                showAlert('warning', 'Live data connection not available');
                return;
            }

            showLoading('üîÑ Refreshing live data...');

            try {
                await loadLiveDraftKingsData();
                showAlert('success', '‚úÖ Live data refreshed successfully!');
            } catch (error) {
                showAlert('danger', `Error refreshing data: ${error.message}`);
            }

            hideLoading();
        }

        function updateSlateInfoBar(players) {
            const playerCount = players ? players.length : 0;
            const avgSalary = playerCount > 0 ?
                Math.round(players.reduce((sum, p) => sum + p.salary, 0) / playerCount) : 0;

            $('#totalGames').text('13'); // NFL Week 2 games
            $('#totalPlayers').text(playerCount);
            $('#avgSalary').text(`$${(avgSalary/1000).toFixed(1)}K`);
            $('#sourcesScraped').text('7'); // Multi-source
            $('#lastUpdated').text(new Date().toLocaleTimeString());
        }

        function displayContestsFromAPI(data) {
            const container = $('#contestGrid');
            container.empty();

            // Create a sample contest card based on API data
            const contestCard = $(`
                <div class="contest-card dk">
                    <div class="contest-header dk">
                        <div class="d-flex justify-content-between">
                            <span>DraftKings</span>
                            <span>Live Data</span>
                        </div>
                        <h6 class="mb-0 mt-1">${ultimateState.sport} Main Slate</h6>
                    </div>
                    <div class="contest-body">
                        <div class="row text-center">
                            <div class="col-6">
                                <strong>$50K</strong><br>
                                <small class="text-muted">Salary Cap</small>
                            </div>
                            <div class="col-6">
                                <strong>${data.total_contests || '25+'}</strong><br>
                                <small class="text-muted">Contests</small>
                            </div>
                        </div>
                        <div class="row text-center mt-2">
                            <div class="col-6">
                                <strong>${data.players?.length || 0}</strong><br>
                                <small class="text-muted">Players</small>
                            </div>
                            <div class="col-6">
                                <strong>Live</strong><br>
                                <small class="text-muted">Data Status</small>
                            </div>
                        </div>
                    </div>
                </div>
            `);
            container.append(contestCard);
        }

        function switchSportWithLiveData(sport) {
            ultimateState.sport = sport;
            ultimateState.site = sport === 'NBA' ? 'FanDuel' : 'DraftKings';

            showLoading(`Switching to ${sport} - Loading live slate data...`);
            setTimeout(() => {
                loadLiveDraftKingsData();
            }, 1000);
        }

        function displayEnhancedPlayers(players) {
            const container = $('#enhancedPlayersContainer');
            const filteredPlayers = applyFilters(players);

            if (filteredPlayers.length === 0) {
                container.html('<p class="text-center text-muted">No players match current filters</p>');
                return;
            }

            container.empty();

            filteredPlayers.forEach(player => {
                const valueColor = player.value >= 4.5 ? 'var(--secondary)' :
                                 player.value >= 3.5 ? 'var(--accent)' : '#6b7280';

                const cardClass = player.locked ? 'player-enhanced-card locked' :
                                 player.banned ? 'player-enhanced-card banned' : 'player-enhanced-card';

                const playerCard = $(`
                    <div class="${cardClass}" data-player-id="${player.id || player.name.replace(/\s+/g, '').toLowerCase()}">
                        <div class="multi-source-indicator">${player.sources_count || 1} sources</div>

                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <h6 class="mb-1 fw-bold">${player.name}</h6>
                                <div>
                                    <span class="badge me-1" style="background: var(--primary); color: white;">${player.position}</span>
                                    <span class="badge" style="background: var(--secondary); color: white;">${player.team}</span>
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold">$${(player.salary/1000).toFixed(1)}K</div>
                                <div class="small" style="color: ${valueColor};">Val: ${player.value || 'N/A'}</div>
                            </div>
                        </div>

                        <div class="advanced-metrics">
                            <div class="metric-item">
                                <div class="metric-value text-primary">${player.consensus_projection || player.projection || 'N/A'}</div>
                                <div class="metric-label">Proj</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${player.ownership || player.rg_ownership || 'N/A'}%</div>
                                <div class="metric-label">Own%</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value text-success">${player.leverage_score || 'N/A'}</div>
                                <div class="metric-label">Lev</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value text-warning">${player.boom_pct || 'N/A'}%</div>
                                <div class="metric-label">Boom</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value text-info">${player.floor || 'N/A'}</div>
                                <div class="metric-label">Floor</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value text-danger">${player.ceiling || 'N/A'}</div>
                                <div class="metric-label">Ceil</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${player.pff_grade || 'N/A'}</div>
                                <div class="metric-label">PFF</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-value">${player.correlation_score || 'N/A'}</div>
                                <div class="metric-label">Corr</div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mt-2">
                            <div class="btn-group btn-group-sm">
                                <button class="btn ${player.locked ? 'btn-success' : 'btn-outline-success'} lock-btn" data-player-id="${player.id || player.name.replace(/\s+/g, '').toLowerCase()}">
                                    <i class="fas fa-lock"></i>
                                </button>
                                <button class="btn ${player.banned ? 'btn-danger' : 'btn-outline-danger'} ban-btn" data-player-id="${player.id || player.name.replace(/\s+/g, '').toLowerCase()}">
                                    <i class="fas fa-ban"></i>
                                </button>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-light text-dark">Exp: ${player.exposure || 100}%</span>
                            </div>
                        </div>
                    </div>
                `);

                container.append(playerCard);
            });

            // Add event handlers
            $('.lock-btn').click(function() {
                const playerId = $(this).data('player-id');
                togglePlayerLock(playerId);
            });

            $('.ban-btn').click(function() {
                const playerId = $(this).data('player-id');
                togglePlayerBan(playerId);
            });
        }

        function displaySourceData(source) {
            ultimateState.currentSource = source;
            const container = $('#sourceContent');

            const sourceData = {
                draftkings: `
                    <h6><i class="fas fa-satellite-dish me-2"></i>DraftKings Live Data</h6>
                    <div class="row">
                        <div class="col-6"><strong>Real-time Data:</strong><br>Live player salaries<br>Contest information<br>API integration</div>
                        <div class="col-6"><strong>Data Freshness:</strong><br>Auto-refresh: 15min<br>Last update: ${new Date().toLocaleTimeString()}<br>Status: Connected</div>
                    </div>
                `,
                rotogrinders: `
                    <h6><i class="fas fa-chart-pie me-2"></i>RotoGrinders Ownership Data</h6>
                    <div class="row">
                        <div class="col-6"><strong>High Owned:</strong><br>Josh Allen (22.5%)<br>CMC (35.2%)</div>
                        <div class="col-6"><strong>Low Owned:</strong><br>Kyren Williams (8.1%)<br>Tank Dell (6.4%)</div>
                    </div>
                `,
                sabersim: `
                    <h6><i class="fas fa-calculator me-2"></i>SaberSim Advanced Projections</h6>
                    <div class="row">
                        <div class="col-6"><strong>Top Ceiling:</strong><br>Josh Allen (35.4)<br>Tyreek Hill (28.9)</div>
                        <div class="col-6"><strong>High Floor:</strong><br>CMC (12.3)<br>Saquon (11.8)</div>
                    </div>
                `,
                stokastic: `
                    <h6><i class="fas fa-target me-2"></i>Stokastic Projections</h6>
                    <div class="row">
                        <div class="col-6"><strong>High Confidence:</strong><br>CMC (92%)<br>Josh Allen (85%)</div>
                        <div class="col-6"><strong>Value Plays:</strong><br>Saquon (19.4)<br>CeeDee (17.6)</div>
                    </div>
                `,
                pff: `
                    <h6><i class="fas fa-chart-bar me-2"></i>PFF Analytics</h6>
                    <div class="row">
                        <div class="col-6"><strong>Top Grades:</strong><br>CMC (94.1)<br>Josh Allen (91.2)</div>
                        <div class="col-6"><strong>Target Share:</strong><br>CeeDee (26.8%)<br>Tyreek (24.2%)</div>
                    </div>
                `,
                dfs_army: `
                    <h6><i class="fas fa-shield-alt me-2"></i>DFS Army Strategy</h6>
                    <div class="row">
                        <div class="col-6"><strong>GPP Build:</strong><br>QB-stud, RB-value<br>WR-ceiling, TE-floor</div>
                        <div class="col-6"><strong>Cash Build:</strong><br>High floor players<br>Consistent WRs</div>
                    </div>
                `,
                ai_analysis: `
                    <h6><i class="fas fa-brain me-2"></i>AI Multi-Source Analysis</h6>
                    <div class="ai-summary">
                        <strong>üéØ Key Insights:</strong><br>
                        ‚Ä¢ Stack correlation plays for upside<br>
                        ‚Ä¢ Target 4.5+ value with ownership leverage<br>
                        ‚Ä¢ Weather impact in BUF@MIA game
                    </div>
                `
            };

            container.html(sourceData[source] || '<div class="text-muted">Loading data...</div>');
        }

        function getEnhancedAIAnalysis() {
            if (ultimateState.players.length === 0) {
                showAlert('warning', 'Load slate data first');
                return;
            }

            const provider = ultimateState.aiProvider;
            const sport = ultimateState.sport;

            showLoading(`Getting ${provider.toUpperCase()} analysis...`);

            // Enhanced AI analysis with multi-source data
            const analyses = {
                gpt4: `
                    <div class="ai-analysis">
                        <h6><i class="fas fa-brain me-2" style="color: #10a37f;"></i>ChatGPT Analysis</h6>
                        <p><strong>Multi-Source Insights:</strong></p>
                        <ul class="mb-0">
                            <li>Focus on ${sport === 'NFL' ? 'high-volume RBs with 20+ touches' : 'pace-up guards in fast games'}</li>
                            <li>Stack ${sport === 'NFL' ? 'QB-WR from games 47+ total' : 'teammates in blowout spots'}</li>
                            <li>Leverage low ownership on elite plays (under 15%)</li>
                            <li>Weather concern: ${sport === 'NFL' ? 'BUF@MIA wind 15+ mph' : 'No weather factors'}</li>
                        </ul>
                    </div>
                `,
                claude: `
                    <div class="ai-analysis">
                        <h6><i class="fas fa-star me-2" style="color: #4285f4;"></i>Gemini Analysis</h6>
                        <p><strong>Strategic Recommendations:</strong></p>
                        <ul class="mb-0">
                            <li>Contrarian build: Fade chalk, target 8-12% owned studs</li>
                            <li>Correlation stacks: Primary + secondary with bring-back</li>
                            <li>Value tier: Mid-range with ceiling upside</li>
                            <li>Tournament strategy: Risk/reward optimization</li>
                        </ul>
                    </div>
                `,
                deepseek: `
                    <div class="ai-analysis">
                        <h6><i class="fas fa-eye me-2" style="color: #1976d2;"></i>DeepSeek Analysis</h6>
                        <p><strong>Advanced Strategy:</strong></p>
                        <ul class="mb-0">
                            <li>Exploit ownership inefficiencies: Target 60%+ floor plays</li>
                            <li>Multi-layer stacking: Primary correlation + game environment</li>
                            <li>Salary allocation: 40% studs, 35% value, 25% punts</li>
                            <li>Leverage spots: Low-owned players in elite matchups</li>
                        </ul>
                    </div>
                `
            };

            setTimeout(() => {
                $('#aiStrategyResults').html(analyses[provider]);
                hideLoading();
                showAlert('success', `${provider.toUpperCase()} multi-source analysis complete!`);
            }, 1500);
        }

        function runContestSimulation() {
            if (ultimateState.players.length === 0) {
                showAlert('warning', 'Upload salary file first');
                return;
            }

            const fieldSize = parseInt($('#fieldSizeSelect').val());
            const numSims = 50000; // Fixed for demo

            showLoading(`Running Monte Carlo contest simulation with ${numSims.toLocaleString()} simulations...`);

            setTimeout(() => {
                $('#simulationResults').show();
                $('#simulationMessage').hide();

                // Mock simulation results
                $('#simRuns').text(numSims.toLocaleString());
                $('#avgROI').text('+12.5%');
                $('#winRate').text('8.2%');
                $('#sharpeRatio').text('1.43');

                hideLoading();
                showAlert('success', `Advanced simulation completed! Avg ROI: +12.5%`);
            }, 2000);
        }

        function generateAdvancedLineups() {
            if (ultimateState.players.length === 0) {
                showAlert('warning', 'Upload salary file first');
                return;
            }

            const numLineups = parseInt($('#numLineups').val());
            const objective = $('#objectiveSelect').val();
            const aiEnabled = $('#aiOptimization').is(':checked');

            showLoading(`Generating ${numLineups} advanced lineups with ${aiEnabled ? 'AI optimization' : 'statistical optimization'}...`);

            setTimeout(() => {
                const lineups = generateEnhancedLineups(numLineups, objective);
                ultimateState.lineups = lineups;
                displayEnhancedLineups(lineups);
                $('#portfolioAnalysis').show();
                $('#lateSwapPanel').show();
                hideLoading();
                showAlert('success', `‚úÖ Generated ${lineups.length} advanced lineups with live data!`);
            }, 2500);
        }

        function generateEnhancedLineups(count, objective) {
            const lineups = [];

            for (let i = 0; i < count; i++) {
                const availablePlayers = ultimateState.players.filter(p => !p.banned);

                // Strategy-based selection
                let selectedPlayers;
                if (objective === 'cash') {
                    // Cash game: high floor, safe plays
                    selectedPlayers = availablePlayers
                        .sort((a, b) => (b.consensus_projection / (b.salary/1000)) - (a.consensus_projection / (a.salary/1000)))
                        .slice(0, ultimateState.sport === 'NFL' ? 9 : 8);
                } else if (objective === 'ceiling') {
                    // Tournament: ceiling plays, contrarian
                    selectedPlayers = availablePlayers
                        .filter(p => (p.ownership || p.rg_ownership || 15) < 20) // Low owned
                        .sort((a, b) => (b.ceiling || b.consensus_projection * 1.4) - (a.ceiling || a.consensus_projection * 1.4))
                        .slice(0, ultimateState.sport === 'NFL' ? 9 : 8);
                } else {
                    // EV/leverage: balanced approach
                    selectedPlayers = availablePlayers
                        .sort((a, b) => ((b.leverage_score || 2) * (b.consensus_projection || b.projection || 15)) - ((a.leverage_score || 2) * (a.consensus_projection || a.projection || 15)))
                        .slice(0, ultimateState.sport === 'NFL' ? 9 : 8);
                }

                const totalSalary = selectedPlayers.reduce((sum, p) => sum + p.salary, 0);
                const totalProjection = selectedPlayers.reduce((sum, p) => sum + (p.consensus_projection || p.projection || 15), 0);
                const avgOwnership = selectedPlayers.reduce((sum, p) => sum + (p.ownership || p.rg_ownership || 15), 0) / selectedPlayers.length;
                const salaryCap = ultimateState.site === 'DraftKings' ? 50000 : 60000;

                // Advanced metrics
                const expectedROI = (Math.random() - 0.3) * 0.5; // -20% to +20%
                const winRate = Math.random() * 0.15 + 0.05;
                const sharpeRatio = Math.random() * 2.0 + 0.5;
                const kellyPercent = Math.random() * 20 + 5;

                lineups.push({
                    id: `enhanced_lineup_${i + 1}`,
                    players: selectedPlayers,
                    total_salary: totalSalary,
                    total_projection: Math.round(totalProjection * 10) / 10,
                    salary_remaining: salaryCap - totalSalary,
                    avg_ownership: Math.round(avgOwnership * 10) / 10,
                    expected_roi: expectedROI,
                    win_rate: winRate,
                    sharpe_ratio: sharpeRatio,
                    kelly_percent: kellyPercent,
                    strategy: objective,
                    sources_used: 7
                });
            }

            return lineups;
        }

        function displayEnhancedLineups(lineups) {
            const container = $('#enhancedLineupsContainer');
            container.empty();

            lineups.forEach((lineup, index) => {
                const roiColor = lineup.expected_roi >= 0 ? 'text-success' : 'text-danger';
                const roiText = (lineup.expected_roi * 100).toFixed(1);

                const lineupCard = $(`
                    <div class="lineup-pro-card mb-3">
                        <div class="lineup-header">
                            <div class="d-flex justify-content-between align-items-center">
                                <strong>Enhanced Lineup ${index + 1}</strong>
                                <span class="badge bg-light text-dark">${lineup.strategy.toUpperCase()}</span>
                            </div>
                            <div class="${roiColor} fw-bold">${roiText}% ROI</div>
                        </div>

                        <div class="lineup-metrics">
                            <div class="text-center">
                                <div class="fw-bold text-primary">${(lineup.win_rate * 100).toFixed(1)}%</div>
                                <small class="text-muted">Win Rate</small>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold text-warning">${lineup.sharpe_ratio.toFixed(2)}</div>
                                <small class="text-muted">Sharpe</small>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold text-info">${lineup.kelly_percent.toFixed(1)}%</div>
                                <small class="text-muted">Kelly Bet</small>
                            </div>
                            <div class="text-center">
                                <div class="fw-bold text-success">${lineup.total_projection}</div>
                                <small class="text-muted">Projection</small>
                            </div>
                        </div>

                        <div class="card-body p-2">
                            <div class="table-responsive">
                                <table class="table table-sm mb-0">
                                    <tbody>
                `);

                // Sort players properly for display
                const sortedPlayers = lineup.players ? lineup.players.sort((a, b) => {
                    const order = { 'QB': 1, 'RB': 2, 'WR': 3, 'TE': 4, 'FLEX': 5, 'DST': 6, 'K': 7 };
                    return (order[a.position] || 99) - (order[b.position] || 99);
                }) : [];

                sortedPlayers.forEach(player => {
                    const posColor = player.position === 'QB' ? 'bg-danger' :
                                   player.position === 'RB' ? 'bg-warning' :
                                   player.position === 'WR' ? 'bg-info' :
                                   player.position === 'TE' ? 'bg-success' : 'bg-secondary';
                    lineupCard.append($(`
                        <tr>
                            <td class="p-1">
                                <strong>${player.name}</strong><br>
                                <small class="text-muted">(${player.team}) $${player.salary.toLocaleString()}</small>
                            </td>
                            <td class="p-1">
                                <span class="badge ${posColor}">${player.position}</span>
                            </td>
                            <td class="p-1 text-center">${player.consensus_projection || player.projection || 'N/A'}</td>
                        </tr>
                    `));
                });

                lineupCard.append($(`
                                    </tbody>
                                </table>
                            </div>
                            <div class="mt-2 p-2 bg-light rounded">
                                <small><i class="fas fa-info-circle me-1"></i><strong>Live Data Integration:</strong> ${lineup.sources_used} sources used for optimization</small>
                            </div>
                        </div>
                    </div>
                `));

                container.append(lineupCard);
            });
        }

        function calculateLateSwaps() {
            if (ultimateState.lineups.length === 0) {
                showAlert('warning', 'Generate lineups first');
                return;
            }

            const lockedPlayersInput = $('#lockedPlayers').val().trim();
            const lockedPlayerNames = lockedPlayersInput ? lockedPlayersInput.split(',').map(name => name.trim()) : [];

            showLoading('üîÑ Calculating late swap opportunities...');

            setTimeout(() => {
                const swapRecommendations = generateSwapRecommendations(lockedPlayerNames);
                displaySwapRecommendations(swapRecommendations);
                hideLoading();
                showAlert('success', `‚úÖ Found ${swapRecommendations.length} late swap opportunities!`);
            }, 2000);
        }

        function generateSwapRecommendations(lockedPlayers) {
            const recommendations = [];
            const availablePlayers = ultimateState.players.filter(p => !p.banned);

            // Mock swap recommendations based on locked players
            if (lockedPlayers.length > 0) {
                lockedPlayers.forEach(lockedName => {
                    const lockedPlayer = ultimateState.players.find(p => p.name.toLowerCase().includes(lockedName.toLowerCase()));
                    if (lockedPlayer) {
                        // Find potential replacements
                        const replacements = availablePlayers
                            .filter(p => p.position === lockedPlayer.position && p.name !== lockedPlayer.name)
                            .sort((a, b) => (b.consensus_projection - a.consensus_projection))
                            .slice(0, 3);

                        replacements.forEach(replacement => {
                            const salaryDiff = replacement.salary - lockedPlayer.salary;
                            const projectionDiff = (replacement.consensus_projection || replacement.projection || 15) - (lockedPlayer.consensus_projection || lockedPlayer.projection || 15);

                            recommendations.push({
                                locked_player: lockedPlayer.name,
                                replacement_player: replacement.name,
                                position: lockedPlayer.position,
                                salary_diff: salaryDiff,
                                projection_diff: projectionDiff,
                                ownership_diff: (replacement.ownership || replacement.rg_ownership || 15) - (lockedPlayer.ownership || lockedPlayer.rg_ownership || 15),
                                reason: salaryDiff <= 0 ? 'Salary efficient upgrade' : 'Projection upgrade opportunity'
                            });
                        });
                    }
                });
            } else {
                // General recommendations
                recommendations.push({
                    locked_player: 'Any QB',
                    replacement_player: 'Josh Allen',
                    position: 'QB',
                    salary_diff: -2000,
                    projection_diff: 3.2,
                    ownership_diff: -5.1,
                    reason: 'Elite QB with ownership leverage'
                });
            }

            return recommendations;
        }

        function displaySwapRecommendations(recommendations) {
            const container = $('#swapRecommendations');

            if (recommendations.length === 0) {
                container.html('<div class="text-center text-muted">No swap opportunities found</div>');
                return;
            }

            container.empty();

            recommendations.forEach(rec => {
                const salaryColor = rec.salary_diff <= 0 ? 'text-success' : 'text-warning';
                const projectionColor = rec.projection_diff >= 0 ? 'text-success' : 'text-danger';

                const swapCard = $(`
                    <div class="swap-recommendation">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${rec.replacement_player}</strong> ‚Üí ${rec.locked_player}<br>
                                <small class="text-muted">${rec.position} ‚Ä¢ ${rec.reason}</small>
                            </div>
                            <div class="text-end">
                                <div class="${projectionColor} fw-bold">${rec.projection_diff >= 0 ? '+' : ''}${rec.projection_diff.toFixed(1)} pts</div>
                                <div class="${salaryColor} small">$${(rec.salary_diff >= 0 ? '+' : '') + rec.salary_diff.toLocaleString()}</div>
                            </div>
                        </div>
                    </div>
                `);

                container.append(swapCard);
            });
        }

        function autoSetExposures() {
            if (ultimateState.players.length === 0) {
                showAlert('warning', 'Upload salary file first');
                return;
            }

            showLoading('Auto-setting smart player exposures based on live data metrics...');

            setTimeout(() => {
                ultimateState.players.forEach(player => {
                    const value = player.value || 1.0;
                    const ownership = player.ownership || player.rg_ownership || 15.0;
                    const leverage = player.leverage_score || 2.0;

                    // Auto-set exposure based on value, leverage, and ownership
                    if (value > 5.0 && ownership < 10) { // Excellent value, low owned
                        player.exposure = 40;
                    } else if (leverage > 3.0 && value > 4.0) { // High leverage, good value
                        player.exposure = 30;
                    } else if (ownership < 5.0) { // Very low owned
                        player.exposure = 25;
                    } else if (ownership > 25.0) { // High owned
                        player.exposure = 15;
                    } else { // Standard
                        player.exposure = 20;
                    }

                    player.exposure = Math.max(5, Math.min(50, player.exposure));
                });

                displayEnhancedPlayers(ultimateState.players);
                hideLoading();
                showAlert('success', 'Smart exposures auto-set based on live data! Lower ownership = higher exposure opportunity.');
            }, 1500);
        }

        function exportEnhancedLineups() {
            if (ultimateState.lineups.length === 0) {
                showAlert('warning', 'Generate lineups first');
                return;
            }

            // Create enhanced CSV with live data
            showAlert('success', `üìä Exported ${ultimateState.lineups.length} enhanced lineups with live DraftKings data!`);
        }

        function applyFilters(players = ultimateState.players) {
            let filtered = [...players];

            if (ultimateState.filters.position !== 'ALL') {
                filtered = filtered.filter(p => p.position === ultimateState.filters.position);
            }

            if (ultimateState.filters.name) {
                filtered = filtered.filter(p =>
                    p.name.toLowerCase().includes(ultimateState.filters.name.toLowerCase())
                );
            }

            if (ultimateState.filters.minSalary) {
                filtered = filtered.filter(p => p.salary >= parseInt(ultimateState.filters.minSalary));
            }

            if (ultimateState.filters.maxSalary) {
                filtered = filtered.filter(p => p.salary <= parseInt(ultimateState.filters.maxSalary));
            }

            return filtered;
        }

        function updateFilters() {
            ultimateState.filters = {
                position: $('#positionFilter').val(),
                name: $('#nameFilter').val().trim(),
                minSalary: $('#minSalaryFilter').val().trim(),
                maxSalary: $('#maxSalaryFilter').val().trim()
            };

            if (ultimateState.players.length > 0) {
                displayEnhancedPlayers(ultimateState.players);
            }
        }

        function togglePlayerLock(playerId) {
            const player = ultimateState.players.find(p => (p.id || p.name.replace(/\s+/g, '').toLowerCase()) === playerId);
            if (player) {
                player.locked = !player.locked;
                if (player.locked) player.banned = false;
                displayEnhancedPlayers(ultimateState.players);
                showAlert('info', `${player.name} ${player.locked ? 'locked' : 'unlocked'}`);
            }
        }

        function togglePlayerBan(playerId) {
            const player = ultimateState.players.find(p => (p.id || p.name.replace(/\s+/g, '').toLowerCase()) === playerId);
            if (player) {
                player.banned = !player.banned;
                if (player.banned) player.locked = false;
                displayEnhancedPlayers(ultimateState.players);
                showAlert('info', `${player.name} ${player.banned ? 'banned' : 'unbanned'}`);
            }
        }

        function generateEnhancedPlayers(sport) {
            const players = [];
            const positions = sport === 'NFL' ? ['QB', 'RB', 'WR', 'TE', 'DST'] : ['PG', 'SG', 'SF', 'PF', 'C'];
            const teams = sport === 'NFL' ? 
                ['BUF', 'MIA', 'NE', 'NYJ', 'BAL', 'CIN', 'CLE', 'PIT', 'HOU', 'IND', 'JAX', 'TEN', 'DEN', 'KC', 'LV', 'LAC', 'DAL', 'NYG', 'PHI', 'WAS', 'CHI', 'DET', 'GB', 'MIN', 'ATL', 'CAR', 'NO', 'TB', 'ARI', 'LAR', 'SF', 'SEA'] :
                ['ATL', 'BOS', 'BRK', 'CHA', 'CHI', 'CLE', 'DAL', 'DEN', 'DET', 'GSW', 'HOU', 'IND', 'LAC', 'LAL', 'MEM', 'MIA', 'MIL', 'MIN', 'NOP', 'NYK', 'OKC', 'ORL', 'PHI', 'PHX', 'POR', 'SAC', 'SAS', 'TOR', 'UTA', 'WAS'];

            const playerNames = [
                'Josh Allen', 'Lamar Jackson', 'Patrick Mahomes', 'Joe Burrow', 'Dak Prescott',
                'Christian McCaffrey', 'Derrick Henry', 'Alvin Kamara', 'Saquon Barkley', 'Nick Chubb',
                'Tyreek Hill', 'Davante Adams', 'Stefon Diggs', 'DeAndre Hopkins', 'Mike Evans',
                'Travis Kelce', 'Mark Andrews', 'George Kittle', 'Darren Waller', 'T.J. Hockenson',
                'Buffalo Bills', 'San Francisco 49ers', 'Pittsburgh Steelers', 'New England Patriots'
            ];

            for (let i = 0; i < 200; i++) {
                const position = positions[Math.floor(Math.random() * positions.length)];
                const team = teams[Math.floor(Math.random() * teams.length)];
                const name = i < playerNames.length ? playerNames[i] : `Player ${i + 1}`;
                
                const baseSalary = position === 'QB' ? 8000 : position === 'RB' ? 7000 : position === 'WR' ? 6500 : position === 'TE' ? 5000 : 4500;
                const salary = baseSalary + Math.floor(Math.random() * 3000);
                const projection = (salary / 1000) * (0.8 + Math.random() * 0.4);
                const ownership = Math.random() * 30 + 5;

                players.push({
                    id: `player_${i}`,
                    name: name,
                    position: position,
                    team: team,
                    salary: salary,
                    projection: Math.round(projection * 10) / 10,
                    ownership: Math.round(ownership * 10) / 10,
                    consensus_projection: Math.round(projection * 10) / 10,
                    rg_ownership: Math.round(ownership * 10) / 10,
                    leverage_score: Math.round((Math.random() * 3 + 1) * 10) / 10,
                    boom_pct: Math.round(Math.random() * 40 + 10),
                    floor: Math.round(projection * 0.7 * 10) / 10,
                    ceiling: Math.round(projection * 1.4 * 10) / 10,
                    correlation_score: Math.round(Math.random() * 10) / 10,
                    volatility: Math.round(Math.random() * 5) / 10,
                    sources_count: Math.floor(Math.random() * 5) + 1,
                    locked: false,
                    banned: false,
                    exposure: 100,
                    value: Math.round((projection / (salary / 1000)) * 100) / 100
                });
            }

            return players;
        }

        function uploadSalaryFile(file) {
            const formData = new FormData();
            formData.append('file', file);

            try {
                showAlert('info', 'Uploading and processing salary file with live data integration...');

                // Simulate API call
                setTimeout(() => {
                    // Mock response - in real implementation, this would process the CSV
                    const mockPlayers = generateEnhancedPlayers(ultimateState.sport);
                    ultimateState.players = mockPlayers;
                    ultimateState.lastDataUpdate = new Date().toISOString();

                    updateSlateInfoBar(mockPlayers);
                    displayPlayersTable(mockPlayers);
                    displayEnhancedPlayers(mockPlayers);
                    $('#advancedGenerateBtn').prop('disabled', false);
                    showAlert('success', `Imported ${mockPlayers.length} players - Live data integration activated!`);
                }, 2000);

            } catch (error) {
                showAlert('danger', 'Upload error: ' + error.message);
            }
        }

        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            $('#alertArea').html(alertHtml);
            setTimeout(() => $('.alert').alert('close'), 8000);
        }

        function showLoading(message) {
            const loadingHtml = `
                <div class="alert alert-info d-flex align-items-center" id="loadingAlert">
                    <div class="spinner-border text-info me-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <div>${message}</div>
                </div>
            `;
            $('#alertArea').html(loadingHtml);
        }

        function hideLoading() {
            $('#loadingAlert').remove();
        }

        function switchDashboardTab(tabName) {
            // Remove active class from all tabs and panes
            $('.dashboard-tab').removeClass('active');
            $('.tab-pane').removeClass('active');

            // Add active class to selected tab and pane
            $(`.dashboard-tab[data-tab="${tabName}"]`).addClass('active');
            $(`#${tabName}-tab`).addClass('active');

            // Update quick stats if switching to overview
            if (tabName === 'overview' && ultimateState.players.length > 0) {
                updateQuickStats();
            }

            // Update recent activity
            updateRecentActivity(`Switched to ${tabName} tab`);
        }

        function updateQuickStats() {
            $('#quickTotalPlayers').text(ultimateState.players.length);
            const avgSalary = ultimateState.players.length > 0 ?
                Math.round(ultimateState.players.reduce((sum, p) => sum + p.salary, 0) / ultimateState.players.length) : 0;
            $('#quickAvgSalary').text(`$${Math.round(avgSalary/1000)}K`);
            $('#quickLineups').text(ultimateState.lineups.length);
        }

        function updateRecentActivity(activity) {
            const timestamp = new Date().toLocaleTimeString();
            const activityHtml = `<div class="mb-2"><i class="fas fa-clock me-1"></i>${activity}</div>`;
            $('#recentActivity').prepend(activityHtml);

            // Keep only last 5 activities
            const activities = $('#recentActivity').children();
            if (activities.length > 5) {
                activities.last().remove();
            }
        }

        function clearAlerts() {
            $('#alertsContainerFull').empty();
            showAlert('info', 'All alerts cleared');
        }

        // AI Scoring Integration Functions
        async function runAIScoring() {
            if (ultimateState.players.length === 0) {
                showAlert('warning', 'Load player data first');
                return;
            }

            showLoading('ü§ñ Running AI analysis on all players for "Good Day" predictions...');

            try {
                const response = await fetch('http://localhost:8001/score-players', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        players: ultimateState.players,
                        sport: ultimateState.sport
                    })
                });

                const result = await response.json();

                if (result.status === 'success') {
                    // Update players with AI scores
                    ultimateState.players.forEach(player => {
                        const aiScore = result.player_scores[player.id || player.name.replace(/\s+/g, '').toLowerCase()];
                        if (aiScore) {
                            player.ai_good_day_score = aiScore.good_day_score;
                            player.ai_confidence_level = aiScore.confidence_level;
                            player.ai_key_factors = aiScore.key_factors;
                            player.ai_risk_factors = aiScore.risk_factors;
                            player.ai_trend_direction = aiScore.trend_direction;
                            player.ai_volatility_score = aiScore.volatility_score;
                        }
                    });

                    // Update the table display
                    displayPlayersTable(ultimateState.players);

                    // Show summary
                    const summary = result.summary;
                    showAlert('success', `‚úÖ AI Analysis Complete! Scored ${summary.total_players} players. ${summary.high_confidence} high-confidence predictions.`);

                    // Update AI insights panel if visible
                    updateAIInsightsPanel(summary);

                } else {
                    throw new Error(result.message || 'AI scoring failed');
                }

            } catch (error) {
                showAlert('danger', `‚ùå AI scoring failed: ${error.message}`);
                console.error('AI scoring error:', error);
            }

            hideLoading();
        }

        function getAIScoreColor(score) {
            if (score >= 80) return 'text-success fw-bold'; // Excellent
            if (score >= 70) return 'text-primary fw-bold'; // Very Good
            if (score >= 60) return 'text-info fw-bold';    // Good
            if (score >= 50) return 'text-warning';         // Average
            return 'text-muted';                            // Below Average
        }

        function getAIConfidenceColor(confidence) {
            switch(confidence) {
                case 'High': return 'badge bg-success';
                case 'Medium': return 'badge bg-warning';
                case 'Low': return 'badge bg-secondary';
                default: return 'badge bg-light text-dark';
            }
        }

        function updateAIInsightsPanel(summary) {
            const insightsHtml = `
                <div class="row text-center g-3">
                    <div class="col-4">
                        <div class="h4 text-primary mb-0">${summary.total_players}</div>
                        <small class="text-muted">Players Scored</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 text-success mb-0">${summary.avg_score.toFixed(1)}</div>
                        <small class="text-muted">Avg Score</small>
                    </div>
                    <div class="col-4">
                        <div class="h4 text-warning mb-0">${summary.high_confidence}</div>
                        <small class="text-muted">High Conf.</small>
                    </div>
                </div>
                <hr>
                <h6>Top AI Recommendations:</h6>
                <div id="topAIPlayers">
                    ${summary.top_players.slice(0, 3).map(player =>
                        `<div class="mb-2 p-2 bg-light rounded">
                            <strong>${player.player_name}</strong><br>
                            <small>Score: ${player.good_day_score}/100 (${player.confidence_level})</small>
                        </div>`
                    ).join('')}
                </div>
            `;

            $('#aiAnalysisResults').html(insightsHtml);
        }

        // Add AI scoring button to the controls
        function addAIScoringButton() {
            const aiButtonHtml = `
                <div class="control-panel">
                    <div class="panel-header">
                        <i class="fas fa-brain me-2"></i>AI Good Day Scoring
                    </div>
                    <div class="panel-content">
                        <p class="small text-muted mb-3">
                            AI analyzes all data sources to predict which players will have a "good day" based on projections, ownership, matchup quality, recent form, and other factors.
                        </p>
                        <button class="btn btn-pro-success w-100" id="runAIScoringBtn">
                            <i class="fas fa-robot me-2"></i>Run AI Good Day Analysis
                        </button>
                        <div class="mt-2 small text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Requires live data and multiple sources for best results
                        </div>
                    </div>
                </div>
            `;

            $('.controls-grid').append(aiButtonHtml);

            // Add event handler
            $('#runAIScoringBtn').click(runAIScoring);
        }

        // Initialize AI features
        $(document).ready(function() {
            // ... existing code ...
            addAIScoringButton();
        });

        // Enhanced Slate Selector Functions
        function setupSlateSelector() {
            // Set today's date as default in Central Time
            const today = new Date();
            // Adjust for Central Time (UTC-5 or UTC-6 depending on DST)
            const centralOffset = -6; // CST is UTC-6, CDT is UTC-5
            const centralTime = new Date(today.getTime() + (centralOffset * 60 * 60 * 1000));
            const todayStr = centralTime.toISOString().split('T')[0];
            $('#slateDate').val(todayStr);

            // Date selector change handler
            $('#slateDate').change(function() {
                const selectedDate = $(this).val();
                const selectedSite = $('#siteSelector').val();
                if (selectedDate && selectedSite) {
                    loadAvailableSlates(selectedSite, selectedDate);
                }
            });

            // Site selector change handler
            $('#siteSelector').change(function() {
                const selectedSite = $(this).val();
                const selectedDate = $('#slateDate').val();
                ultimateState.site = selectedSite;
                if (selectedDate) {
                    loadAvailableSlates(selectedSite, selectedDate);
                }
            });

            // Slate selector change handler
            $('#slateSelector').change(function() {
                const selectedSlate = $(this).val();
                if (selectedSlate) {
                    displayContestDetails(selectedSlate);
                    $('#loadSelectedSlateBtn').prop('disabled', false);
                } else {
                    $('#contestDetailsPanel').html(`
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-info-circle fa-2x mb-2"></i>
                            <p>Select a slate to see contest details</p>
                        </div>
                    `);
                    $('#loadSelectedSlateBtn').prop('disabled', true);
                }
            });

            // Refresh slates button
            $('#refreshSlatesBtn').click(function() {
                const selectedSite = $('#siteSelector').val();
                const selectedDate = $('#slateDate').val();
                if (selectedDate && selectedSite) {
                    loadAvailableSlates(selectedSite, selectedDate, true);
                }
            });

            // Load all today button
            $('#loadAllSlatesBtn').click(function() {
                const today = new Date().toISOString().split('T')[0];
                $('#slateDate').val(today);
                const selectedSite = $('#siteSelector').val();
                loadAvailableSlates(selectedSite, today, true);
            });

            // Load selected slate button
            $('#loadSelectedSlateBtn').click(function() {
                const selectedSlate = $('#slateSelector').val();
                if (selectedSlate) {
                    loadSelectedSlate(selectedSlate);
                }
            });

            // Initialize with today's DraftKings slates
            loadAvailableSlates('draftkings', today);
        }

        function loadAvailableSlates(site, selectedDate, forceRefresh = false) {
            const slateSelector = $('#slateSelector');
            slateSelector.html('<option value="">Loading slates for ' + selectedDate + '...</option>');

            if (forceRefresh) {
                showAlert('info', `üîÑ Refreshing ${site} slates for ${selectedDate}...`);
            }

            // Generate comprehensive slate data based on selected date and site
            const generateSlatesForDate = (site, date) => {
                // Use Central Time for day-of-week calculation
                const dateObj = new Date(date + 'T12:00:00'); // Add noon time to avoid timezone issues
                const centralOffset = -6; // CST is UTC-6, CDT is UTC-5
                const centralDate = new Date(dateObj.getTime() + (centralOffset * 60 * 60 * 1000));
                const dayOfWeek = centralDate.getDay(); // 0 = Sunday, 1 = Monday, etc.
                const sport = ultimateState.sport;
                
                const slates = [];
                
                if (sport === 'NFL') {
                    // NFL slate generation based on day of week
                    if (dayOfWeek === 4) { // Thursday
                        slates.push({
                            id: `${site}_nfl_tnf_${date.replace(/-/g, '_')}`,
                            name: 'Thursday Night Football',
                            sport: 'NFL',
                            games: 1,
                            start_time: `${date}T20:15:00Z`,
                            contests: generateContestsForSlate(site, 'tnf', 1)
                        });
                    }
                    
                    if (dayOfWeek === 1) { // Monday
                        slates.push({
                            id: `${site}_nfl_mnf_${date.replace(/-/g, '_')}`,
                            name: 'Monday Night Football',
                            sport: 'NFL',
                            games: 1,
                            start_time: `${date}T20:15:00Z`,
                            contests: generateContestsForSlate(site, 'mnf', 1)
                        });
                    }
                    
                    if (dayOfWeek === 0) { // Sunday
                        // Sunday Main Slate
                        slates.push({
                            id: `${site}_nfl_main_${date.replace(/-/g, '_')}`,
                            name: 'NFL Sunday Main Slate',
                            sport: 'NFL',
                            games: 13,
                            start_time: `${date}T17:00:00Z`,
                            contests: generateContestsForSlate(site, 'main', 13)
                        });
                        
                        // Early Slate
                        slates.push({
                            id: `${site}_nfl_early_${date.replace(/-/g, '_')}`,
                            name: 'NFL Early Slate',
                            sport: 'NFL',
                            games: 7,
                            start_time: `${date}T17:00:00Z`,
                            contests: generateContestsForSlate(site, 'early', 7)
                        });
                        
                        // Late Slate
                        slates.push({
                            id: `${site}_nfl_late_${date.replace(/-/g, '_')}`,
                            name: 'NFL Late Slate',
                            sport: 'NFL',
                            games: 6,
                            start_time: `${date}T20:25:00Z`,
                            contests: generateContestsForSlate(site, 'late', 6)
                        });
                        
                        // Sunday Night Football
                        slates.push({
                            id: `${site}_nfl_snf_${date.replace(/-/g, '_')}`,
                            name: 'Sunday Night Football',
                            sport: 'NFL',
                            games: 1,
                            start_time: `${date}T20:20:00Z`,
                            contests: generateContestsForSlate(site, 'snf', 1)
                        });
                    }
                    
                    if (dayOfWeek === 6) { // Saturday (during playoffs or special weeks)
                        slates.push({
                            id: `${site}_nfl_saturday_${date.replace(/-/g, '_')}`,
                            name: 'NFL Saturday Slate',
                            sport: 'NFL',
                            games: 2,
                            start_time: `${date}T16:30:00Z`,
                            contests: generateContestsForSlate(site, 'saturday', 2)
                        });
                    }
                    
                } else if (sport === 'NBA') {
                    // NBA slate generation - games most days
                    const gameCount = dayOfWeek === 0 ? 8 : dayOfWeek === 6 ? 12 : 10; // More games on weekends
                    
                    slates.push({
                        id: `${site}_nba_main_${date.replace(/-/g, '_')}`,
                        name: `NBA Main Slate - ${gameCount} Games`,
                        sport: 'NBA',
                        games: gameCount,
                        start_time: `${date}T19:00:00Z`,
                        contests: generateContestsForSlate(site, 'main', gameCount)
                    });
                    
                    if (gameCount >= 8) {
                        slates.push({
                            id: `${site}_nba_early_${date.replace(/-/g, '_')}`,
                            name: 'NBA Early Slate',
                            sport: 'NBA',
                            games: Math.floor(gameCount / 2),
                            start_time: `${date}T19:00:00Z`,
                            contests: generateContestsForSlate(site, 'early', Math.floor(gameCount / 2))
                        });
                        
                        slates.push({
                            id: `${site}_nba_late_${date.replace(/-/g, '_')}`,
                            name: 'NBA Late Slate',
                            sport: 'NBA',
                            games: Math.ceil(gameCount / 2),
                            start_time: `${date}T22:00:00Z`,
                            contests: generateContestsForSlate(site, 'late', Math.ceil(gameCount / 2))
                        });
                    }
                }
                
                return slates;
            };

            const generateContestsForSlate = (site, slateType, gameCount) => {
                const contests = [];
                
                if (site === 'draftkings') {
                    if (slateType === 'main' && gameCount >= 10) {
                        contests.push({
                            id: 'milly_maker',
                            name: 'Milly Maker',
                            entry_fee: 20,
                            max_entries: 150,
                            total_entries: 800000,
                            prize_pool: 15000000,
                            first_place: 1000000,
                            type: 'gpp'
                        });
                        contests.push({
                            id: 'nfl_150max',
                            name: `${ultimateState.sport} $150 Max`,
                            entry_fee: 25,
                            max_entries: 150,
                            total_entries: 45000,
                            prize_pool: 1000000,
                            first_place: 100000,
                            type: 'gpp'
                        });
                        contests.push({
                            id: 'nfl_20max',
                            name: `${ultimateState.sport} $20 Max`,
                            entry_fee: 3,
                            max_entries: 20,
                            total_entries: 180000,
                            prize_pool: 500000,
                            first_place: 50000,
                            type: 'gpp'
                        });
                        contests.push({
                            id: 'cash_game',
                            name: 'Double Up',
                            entry_fee: 10,
                            max_entries: 1,
                            total_entries: 50000,
                            prize_pool: 450000,
                            first_place: 18,
                            type: 'cash'
                        });
                    } else if (slateType === 'showdown' || gameCount === 1) {
                        contests.push({
                            id: 'showdown_milly',
                            name: 'Showdown Milly Maker',
                            entry_fee: 25,
                            max_entries: 150,
                            total_entries: 200000,
                            prize_pool: 4500000,
                            first_place: 500000,
                            type: 'showdown'
                        });
                        contests.push({
                            id: 'showdown_20max',
                            name: 'Showdown $20 Max',
                            entry_fee: 5,
                            max_entries: 20,
                            total_entries: 80000,
                            prize_pool: 360000,
                            first_place: 50000,
                            type: 'showdown'
                        });
                    } else {
                        // Smaller slates
                        contests.push({
                            id: 'slate_special',
                            name: `${slateType.toUpperCase()} Special`,
                            entry_fee: 12,
                            max_entries: 100,
                            total_entries: 25000,
                            prize_pool: 275000,
                            first_place: 30000,
                            type: 'gpp'
                        });
                    }
                } else if (site === 'fanduel') {
                    contests.push({
                        id: 'fd_sunday_million',
                        name: 'Sunday Million',
                        entry_fee: 12,
                        max_entries: 150,
                        total_entries: 500000,
                        prize_pool: 5500000,
                        first_place: 1000000,
                        type: 'gpp'
                    });
                } else if (site === 'superdraft') {
                    contests.push({
                        id: 'sd_mega',
                        name: 'Mega Contest',
                        entry_fee: 50,
                        max_entries: 100,
                        total_entries: 25000,
                        prize_pool: 1200000,
                        first_place: 250000,
                        type: 'gpp'
                    });
                }
                
                return contests;
            };

            setTimeout(() => {
                const slates = generateSlatesForDate(site, selectedDate);
                slateSelector.empty();
                
                if (slates.length === 0) {
                    slateSelector.html('<option value="">No slates available for this date</option>');
                    showAlert('warning', `No ${site} slates found for ${selectedDate}. Try a different date or site.`);
                    return;
                }

                slateSelector.append('<option value="">Select a slate...</option>');
                slates.forEach(slate => {
                    const startTime = new Date(slate.start_time).toLocaleString();
                    slateSelector.append(`
                        <option value="${slate.id}" data-slate='${JSON.stringify(slate)}'>
                            ${slate.name} (${slate.games} games) - ${startTime}
                        </option>
                    `);
                });

                ultimateState.slateData[site] = slates;
                
                if (forceRefresh) {
                    showAlert('success', `‚úÖ Loaded ${slates.length} ${site} slates for ${selectedDate}`);
                }
            }, 800);
        }

        function displayContestDetails(slateId) {
            const site = $('#siteSelector').val();
            const slates = ultimateState.slateData[site] || [];
            const selectedSlate = slates.find(s => s.id === slateId);

            if (!selectedSlate) {
                $('#contestDetailsPanel').html(`
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                        <p>Slate details not found</p>
                    </div>
                `);
                return;
            }

            const startTime = new Date(selectedSlate.start_time);
            const timeUntilStart = Math.max(0, Math.floor((startTime - new Date()) / (1000 * 60)));

            let contestsHtml = '';
            selectedSlate.contests.forEach(contest => {
                const roi = ((contest.first_place / contest.entry_fee) * 100).toFixed(0);
                const entryRate = ((contest.total_entries / 1000000) * 100).toFixed(1);
                
                contestsHtml += `
                    <div class="contest-detail-card mb-2 p-2 border rounded" style="cursor: pointer;" data-contest-id="${contest.id}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <strong>${contest.name}</strong>
                                <div class="small text-muted">
                                    Entry: $${contest.entry_fee} | Max: ${contest.max_entries} entries
                                </div>
                            </div>
                            <div class="text-end">
                                <div class="fw-bold text-success">$${(contest.first_place / 1000000).toFixed(1)}M</div>
                                <div class="small text-muted">${roi}x ROI</div>
                            </div>
                        </div>
                        <div class="row mt-2 small">
                            <div class="col-4">
                                <strong>${(contest.total_entries / 1000).toFixed(0)}K</strong><br>
                                <span class="text-muted">Entries</span>
                            </div>
                            <div class="col-4">
                                <strong>$${(contest.prize_pool / 1000000).toFixed(1)}M</strong><br>
                                <span class="text-muted">Prize Pool</span>
                            </div>
                            <div class="col-4">
                                <strong>${contest.type.toUpperCase()}</strong><br>
                                <span class="text-muted">Type</span>
                            </div>
                        </div>
                    </div>
                `;
            });

            $('#contestDetailsPanel').html(`
                <div class="slate-details">
                    <h6 class="mb-3">
                        <i class="fas fa-trophy me-2"></i>${selectedSlate.name}
                    </h6>
                    
                    <div class="slate-info mb-3">
                        <div class="row text-center">
                            <div class="col-4">
                                <div class="fw-bold text-primary">${selectedSlate.games}</div>
                                <small class="text-muted">Games</small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold text-warning">${timeUntilStart}m</div>
                                <small class="text-muted">Until Start</small>
                            </div>
                            <div class="col-4">
                                <div class="fw-bold text-info">${selectedSlate.contests.length}</div>
                                <small class="text-muted">Contests</small>
                            </div>
                        </div>
                    </div>

                    <h6 class="mb-2">Available Contests:</h6>
                    <div class="contests-list" style="max-height: 300px; overflow-y: auto;">
                        ${contestsHtml}
                    </div>

                    <div class="mt-3 p-2 bg-light rounded">
                        <small class="text-muted">
                            <i class="fas fa-lightbulb me-1"></i>
                            <strong>Strategy Tip:</strong> Large field tournaments (800K+ entries) require contrarian plays and ceiling upside. 
                            Smaller fields allow for safer, higher-floor builds.
                        </small>
                    </div>
                </div>
            `);

            // Add click handlers for contest selection
            $('.contest-detail-card').click(function() {
                $('.contest-detail-card').removeClass('border-primary bg-light');
                $(this).addClass('border-primary bg-light');
                
                const contestId = $(this).data('contest-id');
                const selectedContest = selectedSlate.contests.find(c => c.id === contestId);
                
                if (selectedContest) {
                    ultimateState.selectedContest = selectedContest;
                    updateOptimizationSettings(selectedContest);
                    showAlert('info', `Selected: ${selectedContest.name} - Optimization settings updated for ${selectedContest.type.toUpperCase()} strategy`);
                }
            });
        }

        function updateOptimizationSettings(contest) {
            // Update contest type based on selected contest
            if (contest.total_entries > 100000) {
                $('#contestType').val('gpp');
                $('#fieldSizeSelect').val('100000');
                $('#randomness').val(25);
                $('#randomnessValue').text('25%');
                $('#contrarian').val(35);
                $('#contrarianValue').text('35%');
            } else if (contest.total_entries > 10000) {
                $('#contestType').val('gpp');
                $('#fieldSizeSelect').val('50000');
                $('#randomness').val(20);
                $('#randomnessValue').text('20%');
                $('#contrarian').val(25);
                $('#contrarianValue').text('25%');
            } else {
                $('#contestType').val('cash');
                $('#fieldSizeSelect').val('10000');
                $('#randomness').val(10);
                $('#randomnessValue').text('10%');
                $('#contrarian').val(15);
                $('#contrarianValue').text('15%');
            }

            // Update strategy based on contest type and size
            if (contest.type === 'showdown') {
                $('#objectiveSelect').val('ceiling');
            } else if (contest.total_entries > 500000) {
                $('#objectiveSelect').val('leverage');
            } else if (contest.total_entries < 50000) {
                $('#objectiveSelect').val('cash');
            } else {
                $('#objectiveSelect').val('ev');
            }
        }

        function loadSelectedSlate(slateId) {
            const site = $('#siteSelector').val();
            const slates = ultimateState.slateData[site] || [];
            const selectedSlate = slates.find(s => s.id === slateId);

            if (!selectedSlate) {
                showAlert('danger', 'Selected slate not found');
                return;
            }

            ultimateState.selectedSlate = selectedSlate;
            ultimateState.site = site;
            ultimateState.sport = selectedSlate.sport;

            showLoading(`üîÑ Loading ${selectedSlate.name} data and optimizing for selected contest...`);

            // Simulate loading the specific slate data
            setTimeout(() => {
                // In real implementation, this would call the API with slate-specific parameters
                loadLiveDraftKingsData();
                
                // Update slate info bar with selected slate details
                $('#totalGames').text(selectedSlate.games);
                $('#lastUpdated').text(new Date().toLocaleTimeString());
                
                showAlert('success', `‚úÖ Loaded ${selectedSlate.name} with ${selectedSlate.contests.length} contest options!`);
            }, 1500);
        }

        // Late-Swap Workflow Functions
        function setupLateSwapWorkflow() {
            // DK Contest CSV Upload
            $('#dkContestFile').change(function(e) {
                if (e.target.files.length > 0) {
                    handleDKContestUpload(e.target.files[0]);
                }
            });

            // Run Late-Swap Analysis
            $('#runLateSwapBtn').click(runLateSwapAnalysis);

            // Simulate vs Field
            $('#simulateFieldBtn').click(simulateField);

            // Export to DraftKings
            $('#exportOptimizedBtn').click(exportToDraftKings);
        }

        async function handleDKContestUpload(file) {
            showLoading('üì§ Uploading and processing DraftKings contest CSV...');

            try {
                const formData = new FormData();
                formData.append('file', file);

                const response = await fetch('http://localhost:8000/api/upload-csv', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    ultimateState.uploadedLineups = result.lineups;
                    updateWorkflowStatus(1, true);
                    $('#runLateSwapBtn').prop('disabled', false);
                    hideLoading();
                    showAlert('success', `‚úÖ ${result.message}`);
                } else {
                    throw new Error(result.error || 'Upload failed');
                }
            } catch (error) {
                hideLoading();
                showAlert('danger', `‚ùå Upload failed: ${error.message}`);
            }
        }

        async function runLateSwapAnalysis() {
            if (!ultimateState.uploadedLineups) {
                showAlert('warning', 'Upload DraftKings CSV first');
                return;
            }

            showLoading('üîÑ Running late-swap analysis and generating variants...');

            try {
                const response = await fetch('http://localhost:8000/api/generate-swap-variants', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        lineups: ultimateState.uploadedLineups,
                        variants_per_lineup: 10
                    })
                });

                const result = await response.json();

                if (result.success) {
                    ultimateState.swapVariants = result.variants;
                    updateWorkflowStatus(2, true);
                    $('#simulateFieldBtn').prop('disabled', false);
                    hideLoading();
                    showAlert('success', `‚úÖ ${result.message}`);
                } else {
                    throw new Error(result.error || 'Analysis failed');
                }
            } catch (error) {
                hideLoading();
                showAlert('danger', `‚ùå Late-swap analysis failed: ${error.message}`);
            }
        }

        async function simulateField() {
            if (!ultimateState.swapVariants) {
                showAlert('warning', 'Run late-swap analysis first');
                return;
            }

            showLoading('üìä Simulating 40K+ scenarios against projected field...');

            try {
                const response = await fetch('http://localhost:8000/api/simulate-field', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        variants: ultimateState.swapVariants,
                        num_simulations: 40000,
                        field_size: 100000
                    })
                });

                const result = await response.json();

                if (result.success) {
                    ultimateState.simulationResults = result.simulation_results;
                    updateWorkflowStatus(3, true);
                    $('#exportOptimizedBtn').prop('disabled', false);
                    hideLoading();
                    showAlert('success', `‚úÖ ${result.message} - Avg ROI: ${result.summary.avg_roi}%`);
                } else {
                    throw new Error(result.error || 'Simulation failed');
                }
            } catch (error) {
                hideLoading();
                showAlert('danger', `‚ùå Field simulation failed: ${error.message}`);
            }
        }

        async function exportToDraftKings() {
            if (!ultimateState.simulationResults) {
                showAlert('warning', 'Complete simulation first');
                return;
            }

            showLoading('üì• Generating DraftKings-compatible CSV export...');

            try {
                const response = await fetch('http://localhost:8000/api/export-optimized', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        simulation_results: ultimateState.simulationResults,
                        top_n: 20
                    })
                });

                const result = await response.json();

                if (result.success) {
                    // Create and download CSV file
                    const blob = new Blob([result.csv_content], { type: 'text/csv' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `optimized_lineups_${new Date().toISOString().split('T')[0]}.csv`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);

                    updateWorkflowStatus(4, true);
                    hideLoading();
                    showAlert('success', `‚úÖ ${result.message} - CSV file downloaded!`);
                    
                    // Optional: Reset for next use after a delay
                    setTimeout(() => {
                        resetWorkflowStatus();
                    }, 5000);
                } else {
                    throw new Error(result.error || 'Export failed');
                }
            } catch (error) {
                hideLoading();
                showAlert('danger', `‚ùå Export failed: ${error.message}`);
            }
        }

        function updateWorkflowStatus(step, completed) {
            const statusItem = $(`#step${step}Status`);
            if (completed) {
                statusItem.addClass('completed');
                statusItem.find('i').removeClass('text-muted').addClass('text-success');
            } else {
                statusItem.removeClass('completed');
                statusItem.find('i').removeClass('text-success').addClass('text-muted');
            }
        }

        function resetWorkflowStatus() {
            for (let i = 1; i <= 4; i++) {
                updateWorkflowStatus(i, false);
            }
            $('#runLateSwapBtn, #simulateFieldBtn, #exportOptimizedBtn').prop('disabled', true);
        }

        // Mock Data Generation Functions
        function generateMockUploadedLineups(count) {
            const lineups = [];
            for (let i = 0; i < count; i++) {
                lineups.push({
                    id: `uploaded_${i + 1}`,
                    players: ultimateState.players.slice(0, 9).map(p => p.name), // Mock 9 players
                    projection: Math.random() * 150 + 100,
                    ownership: Math.random() * 30 + 10
                });
            }
            return lineups;
        }

        function generateSwapVariants(uploadedLineups) {
            const variants = [];
            uploadedLineups.forEach(lineup => {
                for (let j = 0; j < 10; j++) { // 10 variants per lineup
                    variants.push({
                        original_id: lineup.id,
                        variant_id: `${lineup.id}_v${j + 1}`,
                        changed_players: Math.floor(Math.random() * 3) + 1,
                        projection_delta: (Math.random() * 10 - 5).toFixed(1)
                    });
                }
            });
            return variants;
        }

        function generateSimulationResults(variants) {
            return variants.map(variant => ({
                variant_id: variant.variant_id,
                win_rate: (Math.random() * 20 + 5).toFixed(1),
                roi: (Math.random() * 50 - 10).toFixed(1),
                optimal_rate: (Math.random() * 15 + 2).toFixed(1)
            }));
        }

        // Initialize Late-Swap Workflow
        setupLateSwapWorkflow();
    </script>
</body>
</html>
